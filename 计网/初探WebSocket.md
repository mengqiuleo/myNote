# åˆæ¢WebSocket

[TOC]



## ä»€ä¹ˆæ˜¯WebSocket

> websocketæ˜¯HTML5çš„ä¸€ä¸ªæ–°åè®®ï¼Œ æ˜¯ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼Œå®ƒå…è®¸æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¼ é€’ä¿¡æ¯ï¼Œå®ç°æµè§ˆå™¨å’Œå®¢æˆ·ç«¯åŒå·¥é€šä¿¡
>
> WebSocket é€šå¸¸è¢«åº”ç”¨åœ¨**å®æ—¶æ€§è¦æ±‚è¾ƒé«˜**çš„åœºæ™¯ï¼Œä¾‹å¦‚èµ›äº‹æ•°æ®ã€è‚¡ç¥¨è¯åˆ¸ã€ç½‘é¡µèŠå¤©å’Œåœ¨çº¿ç»˜å›¾ç­‰ã€‚

ä¸¾ä¾‹ï¼šå› ä¸º HTTP åè®®æœ‰ä¸€ä¸ªç¼ºé™·ï¼šé€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³äº†è§£ä»Šå¤©çš„å¤©æ°”ï¼Œåªèƒ½æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æŸ¥è¯¢ç»“æœã€‚HTTP åè®®åšä¸åˆ°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚è¿™ç§å•å‘è¯·æ±‚çš„ç‰¹ç‚¹ï¼Œæ³¨å®šäº†å¦‚æœæœåŠ¡å™¨æœ‰è¿ç»­çš„çŠ¶æ€å˜åŒ–ï¼Œå®¢æˆ·ç«¯è¦è·çŸ¥å°±éå¸¸éº»çƒ¦ã€‚æˆ‘ä»¬åªèƒ½ä½¿ç”¨"è½®è¯¢"ï¼šæ¯éš”ä¸€æ®µæ—¶å€™ï¼Œå°±å‘å‡ºä¸€ä¸ªè¯¢é—®,è½®è¯¢çš„æ•ˆç‡ä½ï¼Œéå¸¸æµªè´¹èµ„æºï¼ˆå› ä¸ºå¿…é¡»ä¸åœè¿æ¥ï¼Œæˆ–è€… HTTP è¿æ¥å§‹ç»ˆæ‰“å¼€ï¼‰ã€‚å› æ­¤ï¼Œå·¥ç¨‹å¸ˆä»¬ä¸€ç›´åœ¨æ€è€ƒï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ã€‚WebSocket å°±æ˜¯è¿™æ ·å‘æ˜çš„ã€‚



### WebSocketçš„ç‰¹ç‚¹

> æœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼Œæ˜¯çœŸæ­£çš„åŒå‘å¹³ç­‰å¯¹è¯ï¼Œå±äºæœåŠ¡å™¨æ¨é€æŠ€æœ¯çš„ä¸€ç§ã€‚

- ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ã€‚é»˜è®¤ç«¯å£ä¹Ÿæ˜¯ 80 å’Œ 443 ï¼Œå¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚ 

- å»ºç«‹åœ¨TCPåè®®åŸºç¡€ä¹‹ä¸Šï¼Œå’Œhttpåè®®åŒå±äºåº”ç”¨å±‚

- æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚ 

- å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚ 

- æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡

- åè®®æ ‡è¯†ç¬¦æ˜¯wsï¼ˆå¦‚æœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URL,å¦‚ws://localhost:8023



### WebSocketçš„ä¼˜ç‚¹

ç›¸å¯¹äº HTTP åè®®æ¥è¯´ï¼ŒWebSocket å…·æœ‰å¼€é”€å°‘ã€å®æ—¶æ€§é«˜ã€æ”¯æŒäºŒè¿›åˆ¶æ¶ˆæ¯ä¼ è¾“ã€æ”¯æŒæ‰©å±•å’Œæ›´å¥½çš„å‹ç¼©ç­‰ä¼˜ç‚¹ã€‚è¿™äº›ä¼˜ç‚¹å¦‚ä¸‹æ‰€è¿°ï¼š

**è¾ƒå°‘çš„å¼€é”€**

WebSocket åªéœ€è¦ä¸€æ¬¡æ¡æ‰‹ï¼Œåœ¨æ¯æ¬¡ä¼ è¾“æ•°æ®æ—¶åªä¼ è¾“æ•°æ®å¸§å³å¯ã€‚è€Œ HTTP åè®®ä¸‹ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦æºå¸¦å®Œæ•´çš„è¯·æ±‚å¤´ä¿¡æ¯ï¼Œä¾‹å¦‚ User-Agentã€Referer å’Œ Host ç­‰ã€‚æ‰€ä»¥ WebSocket çš„å¼€é”€ç›¸å¯¹äº HTTP æ¥è¯´ä¼šå°‘å¾ˆå¤šã€‚

**æ›´å¼ºçš„å®æ—¶æ€§**

ç”±äºåè®®æ˜¯å…¨åŒå·¥çš„ï¼Œæ‰€ä»¥æœåŠ¡å™¨å¯ä»¥éšæ—¶ä¸»åŠ¨ç»™å®¢æˆ·ç«¯ä¸‹å‘æ•°æ®ã€‚ç›¸å¯¹äºä¸€é—®ä¸€ç­”çš„ HTTP æ¥è¯´ï¼ŒWebSocket åè®®ä¸‹çš„æ•°æ®ä¼ è¾“çš„å»¶è¿Ÿæ˜æ˜¾æ›´å°‘ã€‚

**æ”¯æŒäºŒè¿›åˆ¶æ¶ˆæ¯ä¼ è¾“**

WebSocket å®šä¹‰äº†äºŒè¿›åˆ¶å¸§ï¼Œå¯ä»¥æ›´è½»æ¾åœ°å¤„ç†äºŒè¿›åˆ¶å†…å®¹ã€‚

**æ”¯æŒæ‰©å±•**

å¼€å‘è€…å¯ä»¥æ‰©å±•åè®®ï¼Œæˆ–è€…å®ç°éƒ¨åˆ†è‡ªå®šä¹‰çš„å­åè®®ã€‚

**æ›´å¥½çš„å‹ç¼©**

Websocket åœ¨é€‚å½“çš„æ‰©å±•æ”¯æŒä¸‹ï¼Œå¯ä»¥æ²¿ç”¨ä¹‹å‰å†…å®¹çš„ä¸Šä¸‹æ–‡ã€‚è¿™æ ·åœ¨ä¼ é€’ç±»ä¼¼ç»“æ„çš„æ•°æ®æ—¶ï¼Œå¯ä»¥æ˜¾è‘—åœ°æé«˜å‹ç¼©ç‡ã€‚







## WebSocket çš„æ¡æ‰‹

å’Œ`TCP`ç±»ä¼¼,WebSocketåŒæ ·éœ€è¦ä¸€ä¸ªæ¡æ‰‹çš„è¿‡ç¨‹,æ‰å¯ä»¥æ­£å¸¸çš„æ”¶å‘æ•°æ®ã€‚

å¯¹äº`WebSocket` æ¡æ‰‹æ¥è¯´: æ˜¯ä¸€ä¸ªæ ‡å‡†çš„`HTTP GET`è¯·æ±‚,ä½†æ˜¯è¿™é‡Œéœ€è¦å¸¦ä¸Šä¸¤ä¸ªå­—æ®µ

- `Connection: Upgrade`  è¡¨ç¤ºçš„å«ä¹‰æ˜¯: åè®®è¦å‡çº§
- `Upgrade: WebSocket`   è¡¨ç¤ºè¦`å‡çº§`æˆ `WebSocket`

å½“ç„¶ä¸ºäº†é¿å…ä¸€äº›é—®é¢˜çš„å‡ºç°: ä¸€äº›æ™®é€šçš„`HTTP`è¯·æ±‚ä¼šè¢«`æ„å¤–`è¯†åˆ«æˆ `WebSocket` åˆå¢åŠ äº†ä¸¤ä¸ªé¢å¤–çš„è®¤è¯å¤´çš„å­—æ®µ:

- Sec-WebSocket-Key: ä¸€ä¸ªBase64ç¼–ç çš„16å­—èŠ‚éšæœºæ•°ï¼Œä½œä¸ºç®€å•çš„è®¤è¯å¯†åŒ™
- Sec-WebSocket-Version: åè®®çš„ç‰ˆæœ¬å·

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ æ¡æ‰‹çš„å…·ä½“ç»†èŠ‚ï¼š





### è¯·æ±‚ä¸å“åº”æŠ¥æ–‡

**è¯·æ±‚æŠ¥æ–‡**

```yaml
//è¯·æ±‚æ¶ˆæ¯
GET wss://webchat-bj-test5.clink.cn&province= HTTP/1.1 //è¯·æ±‚åœ°å€
Host: webchat-bj-test5.clink.cn  //åŸŸå
Connection: Upgrade //è¡¨ç¤ºè¦å‡çº§åè®®
Pragma: no-cache  
Cache-Control: no-cache  //ç¼“å­˜ç›¸å…³
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.9 Safari/537.36 //ua
Upgrade: websocket  //è¦å‡çº§åè®®åˆ°websocketåè®®ï¼Œä¸‹é¢è¿™äº›å°±æ˜¯websocketè¿™äº›ä¸œè¥¿äº†
Origin: http://clink2.clink.cn:5050
Sec-WebSocket-Protocol: chat, superchat //æ˜¯ä¸€ä¸ªåˆ—å‡ºçš„å®¢æˆ·ç«¯è¯·æ±‚çš„å­åè®®,æœåŠ¡ç«¯åº”æŒ‰ç…§ä¼˜å…ˆé¡ºåºæ’åˆ—
Sec-WebSocket-Version: 13 // è¡¨ç¤ºwebsocketçš„ç‰ˆæœ¬ã€‚å¦‚æœæœåŠ¡ç«¯ä¸æ”¯æŒè¯¥ç‰ˆæœ¬ï¼Œéœ€è¦è¿”å›ä¸€ä¸ª
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Sec-WebSocket-Key: O5GLCYKZVQi2jTLENobvtg== //å¯¹åº”æœåŠ¡ç«¯å“åº”å¤´çš„Sec-WebSocket-Acceptï¼Œç”±äºæ²¡æœ‰åŒæºé™åˆ¶ï¼Œ
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
```

é‡ç‚¹å­—æ®µæ˜¯è¿™äº›ï¼š

- Connection: Upgrade è¡¨ç¤ºè¦å‡çº§åè®®
- Upgrade: websocket è¦å‡çº§åè®®åˆ°websocketåè®®
- Sec-WebSocket-Version è¡¨ç¤ºwebsocketçš„ç‰ˆæœ¬ã€‚å¦‚æœæœåŠ¡ç«¯ä¸æ”¯æŒè¯¥ç‰ˆæœ¬ï¼Œéœ€è¦è¿”å›ä¸€ä¸ªSec-WebSocket-Versionheaderï¼Œé‡Œé¢åŒ…å«æœåŠ¡ç«¯æ”¯æŒçš„ç‰ˆæœ¬å·ã€‚
- Sec-WebSocket-Key å¯¹åº”æœåŠ¡ç«¯å“åº”å¤´çš„Sec-WebSocket-Acceptï¼Œç”±äºæ²¡æœ‰åŒæºé™åˆ¶ï¼Œwebsocketå®¢æˆ·ç«¯å¯ä»»æ„è¿æ¥æ”¯æŒwebsocketçš„æœåŠ¡ã€‚è¿™ä¸ªå°±ç›¸å½“äºä¸€ä¸ªé’¥åŒ™ä¸€æŠŠé”ï¼Œé¿å…å¤šä½™çš„ï¼Œæ— æ„ä¹‰çš„è¿æ¥ï¼Œé˜²æ­¢æ”»å‡»è€…æ¶æ„æ¬ºéª—æœåŠ¡ç«¯ã€‚
- Secâ€”WebSocket-Protocol æ˜¯ä¸€ä¸ªåˆ—å‡ºçš„å®¢æˆ·ç«¯è¯·æ±‚çš„å­åè®®,æœåŠ¡ç«¯åº”æŒ‰ç…§ä¼˜å…ˆé¡ºåºæ’åˆ—



**å“åº”æŠ¥æ–‡**

```yaml
//å“åº”æ¶ˆæ¯
HTTP/1.1 101 // å“åº”è¡Œï¼Œå‘Šè¯‰ä½ ç‰ˆæœ¬ç›¸å…³
Server: nginx/1.13.9  //æœåŠ¡å™¨ç”¨çš„å•¥
Date: Mon, 30 Mar 2020 09:21:00 GMT   
Connection: upgrade
Vary: Origin
Vary: Access-Control-Request-Method  //è·¨åŸŸç›¸å…³
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Upgrade: websocket    //ä¸‹é¢è¿™äº›å°±æ˜¯websocketçš„ä¸œè¥¿äº†
Sec-WebSocket-Accept: uZpmP+PDDvSeKsEg9vkAsWcqPzE= //è¿™ä¸ªæ˜¯ç»è¿‡æœåŠ¡å™¨ç¡®è®¤ï¼Œå¹¶ä¸”åŠ å¯†è¿‡åçš„ Sec-WebSocket-Key
Sec-WebSocket-Extensions: permessage-deflate;client_max_window_bits=15
```

å…³é”®æ˜¯è¿™ä¸ªå­—æ®µ

- Sec-WebSocket-Accept: éªŒè¯å®¢æˆ·ç«¯çš„è¯·æ±‚æŠ¥æ–‡, åŒæ ·ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢**è¯¯è¿æ¥**ï¼Œç”¨æ¥å‘ŠçŸ¥ï¼šæœåŠ¡å™¨æ„¿æ„å‘èµ·ä¸€ä¸ªwebsocketè¿æ¥ï¼Œ å€¼æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„Sec-WebSocket-Keyè®¡ç®—å‡ºæ¥

- `Connection` å’Œ `Upgrade` è¡¨ç¤ºå·²ç»åˆ‡æ¢æˆ websocket åè®®ã€‚
- `Sec-WebSocket-Accept` åˆ™æ˜¯ç»è¿‡æœåŠ¡å™¨ç¡®è®¤ï¼Œå¹¶ä¸”åŠ å¯†è¿‡åçš„ `Sec-WebSocket-Key`ï¼Œè¿™ä¸ªå€¼æ ¹æ®å®¢æˆ·ç«¯å‘é€çš„ `Sec-WebSocket-Key` ç”Ÿæˆã€‚

è¿™æ ·ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å°±å®Œæˆäº†æ¡æ‰‹æ“ä½œã€‚åŒç«¯è¾¾æˆä¸€è‡´ï¼Œé€šä¿¡åè®®å°†ç”± HTTP åè®®åˆ‡æ¢æˆ WebSocket åè®®ã€‚



### Sec-WebSocket-Key/Acceptçš„ä½œç”¨

å‰é¢æåˆ°äº†ï¼Œ`Sec-WebSocket-Key/Sec-WebSocket-Accept`åœ¨ä¸»è¦ä½œç”¨åœ¨äºæä¾›åŸºç¡€çš„é˜²æŠ¤ï¼Œå‡å°‘æ¶æ„è¿æ¥ã€æ„å¤–è¿æ¥ã€‚

ä½œç”¨å¤§è‡´å½’çº³å¦‚ä¸‹ï¼š

1. é¿å…æœåŠ¡ç«¯æ”¶åˆ°éæ³•çš„websocketè¿æ¥ï¼ˆæ¯”å¦‚httpå®¢æˆ·ç«¯ä¸å°å¿ƒè¯·æ±‚è¿æ¥websocketæœåŠ¡ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¯ä»¥ç›´æ¥æ‹’ç»è¿æ¥ï¼‰
2. ç¡®ä¿æœåŠ¡ç«¯ç†è§£websocketè¿æ¥ã€‚å› ä¸ºwsæ¡æ‰‹é˜¶æ®µé‡‡ç”¨çš„æ˜¯httpåè®®ï¼Œå› æ­¤å¯èƒ½wsè¿æ¥æ˜¯è¢«ä¸€ä¸ªhttpæœåŠ¡å™¨å¤„ç†å¹¶è¿”å›çš„ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡Sec-WebSocket-Keyæ¥ç¡®ä¿æœåŠ¡ç«¯è®¤è¯†wsåè®®ã€‚ï¼ˆå¹¶éç™¾åˆ†ç™¾ä¿é™©ï¼Œæ¯”å¦‚æ€»æ˜¯å­˜åœ¨é‚£ä¹ˆäº›æ— èŠçš„httpæœåŠ¡å™¨ï¼Œå…‰å¤„ç†Sec-WebSocket-Keyï¼Œä½†å¹¶æ²¡æœ‰å®ç°wsåè®®ã€‚ã€‚ã€‚ï¼‰
3. ç”¨æµè§ˆå™¨é‡Œå‘èµ·ajaxè¯·æ±‚ï¼Œè®¾ç½®headeræ—¶ï¼ŒSec-WebSocket-Keyä»¥åŠå…¶ä»–ç›¸å…³çš„headeræ˜¯è¢«ç¦æ­¢çš„ã€‚è¿™æ ·å¯ä»¥é¿å…å®¢æˆ·ç«¯å‘é€ajaxè¯·æ±‚æ—¶ï¼Œæ„å¤–è¯·æ±‚åè®®å‡çº§ï¼ˆwebsocket upgradeï¼‰
4. å¯ä»¥é˜²æ­¢åå‘ä»£ç†ï¼ˆä¸ç†è§£wsåè®®ï¼‰è¿”å›é”™è¯¯çš„æ•°æ®ã€‚æ¯”å¦‚åå‘ä»£ç†å‰åæ”¶åˆ°ä¸¤æ¬¡wsè¿æ¥çš„å‡çº§è¯·æ±‚ï¼Œåå‘ä»£ç†æŠŠç¬¬ä¸€æ¬¡è¯·æ±‚çš„è¿”å›ç»™cacheä½ï¼Œç„¶åç¬¬äºŒæ¬¡è¯·æ±‚åˆ°æ¥æ—¶ç›´æ¥æŠŠcacheä½çš„è¯·æ±‚ç»™è¿”å›ï¼ˆæ— æ„ä¹‰çš„è¿”å›ï¼‰ã€‚
5. Sec-WebSocket-Keyä¸»è¦ç›®çš„å¹¶ä¸æ˜¯ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§ï¼Œå› ä¸ºSec-WebSocket-Keyã€Sec-WebSocket-Acceptçš„è½¬æ¢è®¡ç®—å…¬å¼æ˜¯å…¬å¼€çš„ï¼Œè€Œä¸”éå¸¸ç®€å•ï¼Œæœ€ä¸»è¦çš„ä½œç”¨æ˜¯é¢„é˜²ä¸€äº›å¸¸è§çš„æ„å¤–æƒ…å†µï¼ˆéæ•…æ„çš„ï¼‰ã€‚





### åŒç«¯äº¤äº’æµç¨‹

å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥æˆåŠŸä¹‹å‰ï¼Œä½¿ç”¨çš„é€šä¿¡åè®®æ˜¯ HTTPã€‚è¿æ¥æˆåŠŸåï¼Œä½¿ç”¨çš„æ‰æ˜¯ WebSocket åè®®ã€‚ä¸‹å›¾æè¿°äº†åŒç«¯äº¤äº’çš„æµç¨‹ï¼š

![](./WebSocketå›¾ç‰‡/åŒç«¯äº¤äº’.jpg)

é¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘å‡ºä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦äº†æœåŠ¡ç«¯è§„å®šçš„ä¿¡æ¯ï¼Œå¹¶åœ¨ä¿¡æ¯ä¸­è¡¨æ˜å¸Œæœ›å°†åè®®å‡çº§ä¸º WebSocketã€‚è¿™ä¸ªè¯·æ±‚è¢«ç§°ä¸ºå‡çº§è¯·æ±‚ï¼ŒåŒç«¯å‡çº§åè®®çš„æ•´ä¸ªè¿‡ç¨‹å«åšæ¡æ‰‹ã€‚ç„¶åæœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ï¼Œå¦‚æœç¬¦åˆè§„èŒƒåˆ™å°†åè®®æ›¿æ¢æˆ WebSocketï¼Œå¹¶å°†å‡çº§æˆåŠŸçš„ä¿¡æ¯å“åº”ç»™å®¢æˆ·ç«¯ã€‚æœ€åï¼ŒåŒæ–¹å°±å¯ä»¥åŸºäº WebSocket åè®®äº’ç›¸æ¨é€ä¿¡æ¯äº†ã€‚





### æ•°æ®æ”¶å‘æµç¨‹

åœ¨åŒç«¯å»ºç«‹ WebSocket è¿æ¥åï¼Œä»»ä½•ä¸€ç«¯éƒ½å¯ä»¥ç»™å¦ä¸€ç«¯å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œçš„æ¶ˆæ¯æŒ‡çš„å°±æ˜¯æ•°æ®å¸§ã€‚ä½†å¹³æ—¶æˆ‘ä»¬è¾“å…¥æˆ–è¾“å‡ºçš„ä¿¡æ¯éƒ½æ˜¯â€œæ˜æ–‡â€ï¼Œæ‰€ä»¥åœ¨æ¶ˆæ¯å‘é€å‰éœ€è¦å°†â€œæ˜æ–‡â€é€šè¿‡ä¸€å®šçš„æ–¹æ³•è½¬æ¢æˆæ•°æ®å¸§ã€‚è€Œåœ¨æ¥æ”¶ç«¯ï¼Œæ‹¿åˆ°æ•°æ®å¸§åéœ€è¦æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†æ•°æ®å¸§è½¬æ¢ä¸ºâ€æ˜æ–‡â€œã€‚ä¸‹å›¾æè¿°äº†åŒç«¯æ”¶å‘ `Hello, world` çš„ä¸»è¦æµç¨‹ï¼š

![](./WebSocketå›¾ç‰‡/æ•°æ®å¸§.jpg)

### ä¿æŒè¿æ¥å’Œå…³é—­è¿æ¥

WebSocket åŒç«¯çš„è¿æ¥å¯ä»¥ä¿æŒé•¿æœŸä¸æ–­å¼€ï¼Œä½†å®é™…åº”ç”¨ä¸­å´ä¸ä¼šè¿™ä¹ˆåšã€‚å¦‚æœä¿æŒæ‰€æœ‰è¿æ¥ä¸æ–­å¼€ï¼Œä½†è¿æ¥ä¸­æœ‰å¾ˆå¤šä¸æ´»è·ƒçš„æˆå‘˜ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆä¸¥é‡çš„èµ„æºæµªè´¹ã€‚

æœåŠ¡ç«¯å¦‚ä½•åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦æ´»è·ƒå‘¢ï¼Ÿ

æœåŠ¡ç«¯ä¼šå®šæœŸç»™æ‰€æœ‰çš„å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª opcode ä¸º `%x9` çš„æ•°æ®å¸§ï¼Œè¿™ä¸ªæ•°æ®å¸§è¢«ç§°ä¸º Ping å¸§ã€‚å®¢æˆ·ç«¯åœ¨æ”¶åˆ° Ping å¸§æ—¶ï¼Œå¿…é¡»å›å¤ä¸€ä¸ª opcode ä¸º `%xA` çš„æ•°æ®å¸§ï¼ˆåˆç§°ä¸º Pong å¸§ï¼‰ï¼Œå¦åˆ™æœåŠ¡ç«¯å°±å¯ä»¥ä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚åä¹‹ï¼Œå¦‚æœæœåŠ¡ç«¯åœ¨å‘é€ Ping å¸§åèƒ½å¤Ÿå¾—åˆ°å®¢æˆ·ç«¯ Pong å¸§çš„å›åº”ï¼Œå°±ä»£è¡¨è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯æ´»è·ƒçš„ï¼Œä¸è¦æ–­å¼€è¿æ¥ã€‚

å¦‚æœéœ€è¦å…³é—­è¿æ¥ï¼Œé‚£ä¹ˆä¸€ç«¯å‘å¦ä¸€ç«¯å‘é€ opcode ä¸º `%x8` çš„æ•°æ®å¸§å³å¯ï¼Œè¿™ä¸ªæ•°æ®å¸§è¢«ç§°ä¸ºå…³é—­å¸§ã€‚



## ğŸŒ°WebSocket

### WebSocket API

**äº‹ä»¶**

```csharp
//åˆ›å»ºWebSocketå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨wså’Œwssã€‚ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥é€‰å¡«è‡ªå®šä¹‰åè®®ï¼Œå¦‚æœå¤šåè®®ï¼Œå¯ä»¥ä»¥æ•°ç»„æ–¹å¼
var socket = new WebSocket('ws://demos.kaazing.com/echo');
```

- **onopen**ï¼šè¿æ¥æˆåŠŸåçš„å›è°ƒ

  æœåŠ¡å™¨ç›¸åº”WebSocketè¿æ¥è¯·æ±‚è§¦å‘

  ```ini
  socket.onopen = (event) => {
    socket.send('Hello Server!');
  };
    
  socket.addEventListener('open', function (event) {
    ws.send('Hello Server!');
  });
  ```

- **onmessage**ï¼šå®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨ç«¯æ•°æ®çš„å›è°ƒ

  æœåŠ¡å™¨æœ‰ å“åº”æ•°æ® è§¦å‘

  ```ini
  socket.onmessage = (event) => {
     debugger;
     console.log(event.data);
  };
    
  socket.addEventListener("message", function(event) {
    var data = event.data;
    // å¤„ç†æ•°æ®
  });
  ```

- **onerror**: è¿æ¥å¤±è´¥åçš„å›è°ƒ

  å‡ºé”™æ—¶è§¦å‘ï¼Œå¹¶ä¸”ä¼šå…³é—­è¿æ¥ã€‚è¿™æ—¶å¯ä»¥æ ¹æ®é”™è¯¯ä¿¡æ¯è¿›è¡ŒæŒ‰éœ€å¤„ç†

  ```javascript
  socket.onerror = (event) => {
    console.log('error');
  }
  ```

- **onclose**ï¼šè¿æ¥å…³é—­åçš„å›è°ƒ

  ```javascript
   è¿æ¥å…³é—­æ—¶è§¦å‘ï¼Œè¿™åœ¨ä¸¤ç«¯éƒ½å¯ä»¥å…³é—­ã€‚å¦å¤–å¦‚æœè¿æ¥å¤±è´¥ä¹Ÿæ˜¯ä¼šè§¦å‘çš„ã€‚
   é’ˆå¯¹å…³é—­ä¸€èˆ¬æˆ‘ä»¬ä¼šåšä¸€äº›å¼‚å¸¸å¤„ç†,å…³äºå¼‚å¸¸å‚æ•°ï¼š
  
   1. socket.readyState  
   		2 æ­£åœ¨å…³é—­  3 å·²ç»å…³é—­
   2. event.wasClean [Boolean]  
   		true  å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯è°ƒç”¨closeä¸»åŠ¨å…³é—­
    	false åä¹‹
   3. event.code [Number] å…³é—­è¿æ¥çš„çŠ¶æ€ç ã€‚socket.close(code, reason)
   4. event.reason [String] 
   		å…³é—­è¿æ¥çš„åŸå› ã€‚socket.close(code, reason)
           
       
  
  socket.onclose = function(event) {
    var code = event.code;
    var reason = event.reason;
    var wasClean = event.wasClean;
    // handle close event
  };
  
  socket.addEventListener("close", function(event) {
    var code = event.code;
    var reason = event.reason;
    var wasClean = event.wasClean;
    // handle close event
  });
  ```

**æ–¹æ³•**

- **send**ï¼šå‘æœåŠ¡å™¨å‘é€æ•°æ®

  send(data) å‘é€æ–¹æ³• data å¯ä»¥æ˜¯String/Blob/ArrayBuffer/ByteBufferç­‰

  éœ€è¦æ³¨æ„,ä½¿ç”¨sendå‘é€æ•°æ®ï¼Œå¿…é¡»æ˜¯è¿æ¥å»ºç«‹ä¹‹åã€‚ä¸€èˆ¬ä¼šåœ¨onopenäº‹ä»¶è§¦å‘åå‘é€ï¼š

  ```ini
  socket.onopen = (event) => {
     socket.send('Hello Server!');
  };
  ```

  å¦‚æœæ˜¯éœ€è¦å»å“åº”åˆ«çš„äº‹ä»¶å†å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯å°†WebSocketå®ä¾‹socketäº¤ç»™åˆ«çš„æ–¹æ³•ä½¿ç”¨ï¼Œå› ä¸ºåœ¨å‘é€æ—¶ä½ ä¸ä¸€å®šçŸ¥é“socketæ˜¯å¦è¿˜è¿æ¥ç€ï¼Œæ‰€ä»¥å¯ä»¥æ£€æŸ¥readyStateå±æ€§çš„å€¼æ˜¯å¦ç­‰äºOPENå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯æŸ¥çœ‹socketæ˜¯å¦è¿˜è¿æ¥ç€ã€‚

  ```ini
  btn.onclick = function startSocket(){
        //åˆ¤æ–­æ˜¯å¦è¿æ¥æ˜¯å¦è¿˜å­˜åœ¨
        if(socket.readyState == WebSocket.OPEN){
            var message = document.getElementById("message").value;
            if(message != "") socket.send(message);
        }
  }
  ```

- **close**ï¼šå…³é—­å½“å‰è¿æ¥

  ä½¿ç”¨close([code[,reason]])æ–¹æ³•å¯ä»¥å…³é—­è¿æ¥ã€‚codeå’Œreasonå‡ä¸ºé€‰å¡«

  ```go
    // æ­£å¸¸å…³é—­
    socket.close(1000, "closing normally");
  ```

**å¸¸é‡**ï¼šwebSocket.readyState**

| å¸¸é‡å     | å€¼   | æè¿°             |
| ---------- | ---- | ---------------- |
| CONNECTING | 0    | è¿æ¥è¿˜æœªå¼€å¯     |
| OPEN       | 1    | è¿æ¥å¼€å¯å¯ä»¥é€šä¿¡ |
| CLOSING    | 2    | è¿æ¥æ­£åœ¨å…³é—­ä¸­   |
| CLOSED     | 3    | è¿æ¥å·²ç»å…³é—­     |

**å±æ€§**

| å±æ€§å         | å€¼ç±»å‹       | æè¿°                                                         |
| -------------- | ------------ | ------------------------------------------------------------ |
| binaryType     | String       | è¡¨ç¤ºè¿æ¥ä¼ è¾“çš„äºŒè¿›åˆ¶æ•°æ®ç±»å‹çš„å­—ç¬¦ä¸²ã€‚é»˜è®¤ä¸º"blob"ã€‚         |
| bufferedAmount | Number       | åªè¯»ã€‚å¦‚æœä½¿ç”¨send()æ–¹æ³•å‘é€çš„æ•°æ®è¿‡å¤§ï¼Œè™½ç„¶send()æ–¹æ³•ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œä½†æ•°æ®å¹¶ä¸æ˜¯é©¬ä¸Šä¼ è¾“ã€‚æµè§ˆå™¨ä¼šç¼“å­˜åº”ç”¨æµå‡ºçš„æ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨bufferedAmountå±æ€§æ£€æŸ¥å·²ç»è¿›å…¥é˜Ÿåˆ—ä½†è¿˜æœªè¢«ä¼ è¾“çš„æ•°æ®å¤§å°ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥é¿å…ç½‘ç»œé¥±å’Œã€‚ |
| protocol       | String/Array | åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œprotocolå‚æ•°è®©æœåŠ¡ç«¯çŸ¥é“å®¢æˆ·ç«¯ä½¿ç”¨çš„WebSocketåè®®ã€‚è€Œåœ¨å®ä¾‹socketä¸­å°±æ˜¯è¿æ¥å»ºç«‹å‰ä¸ºç©ºï¼Œè¿æ¥å»ºç«‹åä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ç¡®å®šä¸‹æ¥çš„åè®®åç§°ã€‚ |
| readyState     | String       | åªè¯»ã€‚è¿æ¥å½“å‰çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€æ˜¯ä¸å¸¸é‡ç›¸å¯¹åº”çš„ã€‚               |
| extensions     | String       | æœåŠ¡å™¨é€‰æ‹©çš„æ‰©å±•ã€‚ç›®å‰ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²æˆ–é€šè¿‡è¿æ¥åå•†çš„æ‰©å±•åˆ—è¡¨ã€‚ |



### demo

```js
//é¦–å…ˆnewä¸€ä¸ªwebsocketå¯¹è±¡ï¼Œ
var ws = new WebSocket("wss://webchat-bj-test5.clink.cn");
//å®ä¾‹å¯¹è±¡çš„onopenå±æ€§ï¼Œç”¨äºæŒ‡å®šè¿æ¥æˆåŠŸåçš„å›è°ƒå‡½æ•°ã€‚
ws.onopen = function(evt) { 
  console.log("Connection open ..."); 
  //å®ä¾‹å¯¹è±¡çš„send()æ–¹æ³•ç”¨äºå‘æœåŠ¡å™¨å‘é€æ•°æ®ã€‚
  ws.send("Hello WebSockets!");
};
//å®ä¾‹å¯¹è±¡çš„onmessageå±æ€§ï¼Œç”¨äºæŒ‡å®šæ”¶åˆ°æœåŠ¡å™¨æ•°æ®åçš„å›è°ƒå‡½æ•°ã€‚
ws.onmessage = function(evt) {
  console.log( "Received Message: " + evt.data);
  ws.close();
};
//å®ä¾‹å¯¹è±¡çš„oncloseå±æ€§ï¼Œç”¨äºæŒ‡å®šè¿æ¥å…³é—­åçš„å›è°ƒå‡½æ•°ã€‚
ws.onclose = function(evt) {
  console.log("Connection closed.");
};     
```

å½“ç„¶ï¼ŒåŸç”Ÿçš„ä¸œè¥¿æ˜¯ç›¸å½“ä¸å¥½ç”¨çš„ï¼Œå› ä¸ºä½ è™½ç„¶å»ºç«‹äº†é“¾æ¥ï¼Œåç«¯å¤„ç†å™¨èµ·æ¥å´ä¸æ˜¯é‚£ä¹ˆå¾—å¿ƒåº”æ‰‹ï¼Œæ‰€ä»¥å‡ºç°äº†åº“ï¼šsocketIO



### è·¨å¹³å°çš„WebSocketé€šä¿¡åº“socket.io

> SocketIOå°†WebSocketã€AJAXå’Œå…¶å®ƒçš„é€šä¿¡æ–¹å¼å…¨éƒ¨å°è£…æˆäº†ç»Ÿä¸€çš„é€šä¿¡æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨SocketIOæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒå…¼å®¹é—®é¢˜ï¼Œåº•å±‚ä¼šè‡ªåŠ¨é€‰ç”¨æœ€ä½³çš„é€šä¿¡æ–¹å¼ã€‚å› æ­¤è¯´ï¼ŒWebSocketæ˜¯SocketIOçš„ä¸€ä¸ªå­é›†ã€‚
>
> è·¨å¹³å°çš„WebSocketé€šä¿¡åº“ï¼Œå…·æœ‰å‰åç«¯ä¸€è‡´çš„APIï¼Œå¯ä»¥è§¦å‘å’Œå“åº”è‡ªå®šä¹‰çš„äº‹ä»¶ã€‚socket.ioæœ€æ ¸å¿ƒçš„ä¸¤ä¸ªapiå°±æ˜¯emit å’Œ onäº† ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½æœ‰è¿™ä¸¤ä¸ªapiã€‚é€šè¿‡ emit å’Œ onå¯ä»¥å®ç°æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„åŒå‘é€šä¿¡ã€‚
>
> - emit ï¼šå‘å°„ä¸€ä¸ªäº‹ä»¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºäº‹ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¦å‘é€çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼ˆå¦‚éœ€å¯¹æ–¹æ¥å—åˆ°ä¿¡æ¯åç«‹å³å¾—åˆ°ç¡®è®¤æ—¶ï¼Œåˆ™éœ€è¦ç”¨åˆ°å›è°ƒå‡½æ•°ï¼‰ã€‚ 
> - on ï¼šç›‘å¬ä¸€ä¸ª emit å‘å°„çš„äº‹ä»¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¦ç›‘å¬çš„äº‹ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶å¯¹æ–¹å‘æ¥çš„æ•°æ®ï¼Œè¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ¥æ”¶çš„æ•°æ®ã€‚

**æœåŠ¡ç«¯**

```javascript
var app = require('express')();
var http = require('http');
var socketio  = require("socket.io");
const server = http.createServer(app)
const io = socketio(server)
var count = 0;
// WebSocket è¿æ¥æœåŠ¡å™¨
io.on('connection', (socket)=> {
    //// æ‰€æœ‰çš„äº‹ä»¶è§¦å‘å“åº”éƒ½å†™åœ¨è¿™é‡Œ
    setInterval(()=>{
        count++
        //å‘å»ºç«‹è¯¥è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
        socket.emit('mynameEv', { name:"ä½ æˆ‘è´·"+count})
    },1000)
    //ç›‘å¬å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
    socket.on('yournameEv', function (data) {
        console.log(data)
    })
})

app.get('/', function (req, res) {
    res.sendfile(__dirname + '/index.html');
});
// å¯ç”¨3000ç«¯å£
server.listen(3000)
```

**å®¢æˆ·ç«¯**

```js
<body>
   <div id="myname"></div>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
   <script>
      var count = 0;
      const socket = io.connect('http://localhost:3000')
      socket.on('mynameEv', (data)=>{
          document.getElementById("myname").innerHTML = data.name;
         console.log(data.name)
         setInterval(()=>{
                count++
                socket.emit('yournameEv', { name:"é£æ—‹"+count})
         },1000)

      })
   </script>
</body>
```



## é•¿è½®è¯¢å’ŒçŸ­è½®è¯¢

### è½®è¯¢

**è½®è¯¢** å°±æ˜¯ä¸æ–­åœ°å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œè¯¢é—®ç°åœ¨è¿˜æœ‰æ²¡æœ‰æ•°æ®å•Šï¼Œæœ‰æ•°æ®çš„è¯æœåŠ¡ç«¯å°±ä¼šç”¨å“åº”æŠ¥æ–‡æ¥å›åº”ã€‚å…¶å®,å‰ç«¯å¯èƒ½ä¼šæœ‰ç±»ä¼¼çš„åœºæ™¯,éœ€è¦ä¸åœæŸ¥è¯¢æŸä¸ªé˜¶æ®µçš„è®¡ç®—ç»“æœï¼›å½“ç„¶éœ€è¦ä½ å»è®¾ç½®ä¸€ä¸ªå¾ˆå°çš„æŸ¥è¯¢é—´éš”å»å¢åŠ æŸ¥è¯¢çš„é¢‘ç‡, ä¼¼ä¹å°±æ˜¯å¤„äºä¸€ç§`å®æ—¶é€šä¿¡`çš„çŠ¶æ€ã€‚

ä½†æ˜¯,ç”±æ­¤ä¼šå¸¦æ¥ä¸€ç³»åˆ—çš„é—®é¢˜:

- æœåŠ¡ç«¯ï¼šå¤§é‡`TCP`æ½œåœ¨çš„è¿æ¥äº¤äº’;æ—¢è¦æ¥æ”¶æ•°æ®;åˆè¦å¤„ç†æ•°æ®è¿”å›
- åº”ç”¨å±‚(HTTP)å¼€é”€è¿‡å¤§
- å®¢æˆ·ç«¯ï¼šéœ€è¦å¯¹å‘é€å’Œæ¥æ”¶çš„æ•°æ®å¤„ç†å¦‚ä½•å¤„ç†ä¹ŸåŒæ ·æ˜¯ä¸€ä¸ªé—®é¢˜



![](./WebSocketå›¾ç‰‡/è½®è¯¢.jpg)

é¦–å…ˆï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡ç«¯å‘å‡ºä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚çš„æ„å›¾å°±æ˜¯å‘æœåŠ¡å™¨è¯¢é—®â€œå¤§å“¥ï¼Œæœ‰æ–°æ•°æ®å—ï¼Ÿâ€ã€‚æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œæ ¹æ®å®é™…æƒ…å†µï¼ˆæœ‰æ•°æ®æˆ–æ— æ•°æ®ï¼‰åšå‡ºå“åº”ï¼š

- æœ‰æ•°æ®ï¼Œæˆ‘å‘ç»™ä½ ï¼›
- æ— æ•°æ®ï¼Œä½ å¾…ä¼šå†é—®ï¼›

è¿™ç§ä¸€é—®ä¸€ç­”çš„æ–¹å¼æœ‰ç€æ˜æ˜¾çš„ç¼ºç‚¹ï¼Œå³æµè§ˆå™¨éœ€è¦ä¸æ–­çš„å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ã€‚ç”±äº HTTP è¯·æ±‚åŒ…å«è¾ƒé•¿çš„å¤´éƒ¨ä¿¡æ¯ï¼ˆä¾‹å¦‚ User-Agentã€Referer å’Œ Host ç­‰ï¼‰ï¼Œå…¶ä¸­çœŸæ­£æœ‰æ•ˆçš„æ•°æ®å¯èƒ½åªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™æ ·ä¼šæµªè´¹å¾ˆå¤šçš„å¸¦å®½èµ„æºã€‚



åœ¨ WebSocket åè®®ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œå°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚ä¸‹å›¾æè¿°äº† WebSocket åè®®ä¸­ï¼ŒåŒç«¯é€šä¿¡çš„è¿‡ç¨‹ï¼š

![](./WebSocketå›¾ç‰‡/websocket.jpg)



### é•¿/çŸ­è½®è¯¢

**çŸ­è½®è¯¢çš„åŸºæœ¬æ€è·¯ï¼š** æµè§ˆå™¨æ¯éš”ä¸€æ®µæ—¶é—´å‘æµè§ˆå™¨å‘é€ http è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¸è®ºæ˜¯å¦æœ‰æ•°æ®æ›´æ–°ï¼Œéƒ½ç›´æ¥è¿›è¡Œå“åº”ã€‚è¿™ç§æ–¹å¼å®ç°çš„å³æ—¶é€šä¿¡ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯æµè§ˆå™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥å—è¯·æ±‚çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œé€šè¿‡è®©å®¢æˆ·ç«¯ä¸æ–­çš„è¿›è¡Œè¯·æ±‚ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿæ¨¡æ‹Ÿå®æ—¶åœ°æ”¶åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®çš„å˜åŒ–ã€‚è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒç®€å•ï¼Œæ˜“äºç†è§£ã€‚ç¼ºç‚¹æ˜¯è¿™ç§æ–¹å¼ç”±äºéœ€è¦ä¸æ–­çš„å»ºç«‹ http è¿æ¥ï¼Œä¸¥é‡æµªè´¹äº†æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„èµ„æºã€‚å½“ç”¨æˆ·å¢åŠ æ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„å‹åŠ›å°±ä¼šå˜å¤§ï¼Œè¿™æ˜¯å¾ˆä¸åˆç†çš„ã€‚å…·ä½“æ¯”å¦‚åœ¨ä¸€ä¸ªç”µå•†åœºæ™¯ï¼Œå•†å“çš„åº“å­˜å¯èƒ½ä¼šå˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦åŠæ—¶åæ˜ ç»™ç”¨æˆ·ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¼šä¸åœçš„å‘è¯·æ±‚ï¼Œç„¶åæœåŠ¡å™¨ç«¯ä¼šä¸åœçš„å»æŸ¥å˜åŒ–ï¼Œä¸ç®¡å˜ä¸å˜ï¼Œéƒ½è¿”å›ï¼Œè¿™ä¸ªæ˜¯çŸ­è½®è¯¢ã€‚

**é•¿è½®è¯¢çš„åŸºæœ¬æ€è·¯ï¼š** é¦–å…ˆç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚åï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šç›´æ¥è¿›è¡Œå“åº”ï¼Œè€Œæ˜¯å…ˆå°†è¿™ä¸ªè¯·æ±‚æŒ‚èµ·ï¼Œç„¶ååˆ¤æ–­æœåŠ¡å™¨ç«¯æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ã€‚å¦‚æœæœ‰æ›´æ–°ï¼Œåˆ™è¿›è¡Œå“åº”ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ•°æ®ï¼Œåˆ™åˆ°è¾¾ä¸€å®šçš„æ—¶é—´é™åˆ¶æ‰è¿”å›ã€‚å®¢æˆ·ç«¯ JavaScript å“åº”å¤„ç†å‡½æ•°ä¼šåœ¨å¤„ç†å®ŒæœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯åï¼Œå†æ¬¡å‘å‡ºè¯·æ±‚ï¼Œé‡æ–°å»ºç«‹è¿æ¥ã€‚é•¿è½®è¯¢å’ŒçŸ­è½®è¯¢æ¯”èµ·æ¥ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯æ˜æ˜¾å‡å°‘äº†å¾ˆå¤šä¸å¿…è¦çš„ http è¯·æ±‚æ¬¡æ•°ï¼Œç›¸æ¯”ä¹‹ä¸‹èŠ‚çº¦äº†èµ„æºã€‚é•¿è½®è¯¢çš„ç¼ºç‚¹åœ¨äºï¼Œè¿æ¥æŒ‚èµ·ä¹Ÿä¼šå¯¼è‡´èµ„æºçš„æµªè´¹ã€‚æ€»ç»“ï¼šé•¿è½®è¯¢åˆ™è¡¨ç°ä¸ºå¦‚æœæ²¡æœ‰å˜ï¼Œå°±ä¸è¿”å›ï¼Œè€Œæ˜¯ç­‰å¾…å˜æˆ–è€…è¶…æ—¶ï¼ˆä¸€èˆ¬æ˜¯åå‡ ç§’ï¼‰æ‰è¿”å›ï¼Œå¦‚æœæ²¡æœ‰è¿”å›ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¸éœ€è¦ä¸€ç›´å‘è¯·æ±‚ï¼Œæ‰€ä»¥å‡å°‘äº†åŒæ–¹çš„å‹åŠ›ã€‚



> WebSocket æ˜¯é•¿è½®è¯¢ã€‚





### æ‹“å±•ï¼šé•¿çŸ­è½®è¯¢å’Œé•¿çŸ­è¿æ¥çš„åŒºåˆ«

å¦‚æœä¸äº†è§£é•¿è¿æ¥ï¼ŒğŸ‘‰[å…³äºkeep-alive](https://blog.csdn.net/weixin_52834435/article/details/127353264?spm=1001.2014.3001.5502)

ç¬¬ä¸€ä¸ªåŒºåˆ«æ˜¯å†³å®šçš„æ–¹å¼ï¼Œä¸€ä¸ªHTTPè¿æ¥æ˜¯å¦ä¸ºé•¿è¿æ¥ï¼Œæ˜¯é€šè¿‡è®¾ç½®HTTPçš„Connection Headeræ¥å†³å®šçš„ï¼Œè€Œä¸”æ˜¯éœ€è¦ä¸¤è¾¹éƒ½è®¾ç½®æ‰æœ‰æ•ˆã€‚è€Œä¸€ç§è½®è¯¢æ–¹å¼æ˜¯å¦ä¸ºé•¿è½®è¯¢ï¼Œæ˜¯æ ¹æ®æœåŠ¡ç«¯çš„å¤„ç†æ–¹å¼æ¥å†³å®šçš„ï¼Œä¸å®¢æˆ·ç«¯æ²¡æœ‰å…³ç³»ã€‚

ç¬¬äºŒä¸ªåŒºåˆ«å°±æ˜¯å®ç°çš„æ–¹å¼ï¼Œè¿æ¥çš„é•¿çŸ­æ˜¯é€šè¿‡åè®®æ¥è§„å®šå’Œå®ç°çš„ã€‚è€Œè½®è¯¢çš„é•¿çŸ­ï¼Œæ˜¯æœåŠ¡å™¨é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼æ‰‹åŠ¨æŒ‚èµ·è¯·æ±‚æ¥å®ç°çš„ã€‚



## WebSocketå’ŒSocketçš„åŒºåˆ«

### Socket

- TPC/IPåè®®æ˜¯ä¼ è¾“å±‚åè®®ï¼Œä¸»è¦è§£å†³æ•°æ®å¦‚ä½•åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼›
- Socketæ˜¯å¯¹TCP/IPåè®®çš„å°è£…å’Œåº”ç”¨(ç¨‹åºå‘˜å±‚é¢ä¸Š)ï¼›
- è€ŒHTTPæ˜¯åº”ç”¨å±‚åè®®ï¼Œä¸»è¦è§£å†³å¦‚ä½•åŒ…è£…æ•°æ®ã€‚

1. socketä¹Ÿè¢«ç§°ä¸º`å¥—æ¥å­—`ï¼Œä¸HTTPå’ŒWebSocketä¸ä¸€æ ·ï¼Œsocketä¸æ˜¯åè®®ï¼Œå®ƒæ˜¯åœ¨ç¨‹åºå±‚é¢ä¸Šå¯¹ä¼ è¾“å±‚åè®®ï¼ˆå¯ä»¥ä¸»è¦ç†è§£ä¸ºTCP/IPï¼‰çš„æ¥å£å°è£…ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªèƒ½å¤Ÿæä¾›ç«¯å¯¹ç«¯çš„é€šä¿¡çš„è°ƒç”¨æ¥å£ï¼ˆAPIï¼‰
2. å¯¹äºç¨‹åºå‘˜è€Œè¨€ï¼Œå…¶éœ€è¦åœ¨ A ç«¯åˆ›å»ºä¸€ä¸ª socket å®ä¾‹ï¼Œå¹¶ä¸ºè¿™ä¸ªå®ä¾‹æä¾›å…¶æ‰€è¦è¿æ¥çš„ B ç«¯çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè€Œåœ¨ B ç«¯åˆ›å»ºå¦ä¸€ä¸ª socket å®ä¾‹ï¼Œå¹¶ä¸”ç»‘å®šæœ¬åœ°ç«¯å£å·æ¥è¿›è¡Œç›‘å¬ã€‚å½“ A å’Œ B å»ºç«‹è¿æ¥åï¼ŒåŒæ–¹å°±å»ºç«‹äº†ä¸€ä¸ªç«¯å¯¹ç«¯çš„ TCP è¿æ¥ï¼Œä»è€Œå¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡ã€‚WebSocektå€Ÿé‰´äº† socket çš„æ€æƒ³ï¼Œä¸º client å’Œ server ä¹‹é—´æä¾›äº†ç±»ä¼¼çš„åŒå‘é€šä¿¡æœºåˆ¶

Socketæ˜¯ä»€ä¹ˆå‘¢ï¼Œå®é™…ä¸Šsocketæ˜¯å¯¹TCP/IPåè®®çš„å°è£…ï¼ŒSocketæœ¬èº«å¹¶ä¸æ˜¯åè®®ï¼Œè€Œæ˜¯ä¸€ä¸ªè°ƒç”¨æ¥å£(API)ã€‚é€šè¿‡Socketï¼Œæˆ‘ä»¬æ‰èƒ½ä½¿ç”¨TCP/IPåè®®ã€‚
**Socketè·ŸTCP/IPåè®®å…³ç³»**æ˜¯ï¼šâ€œTCP/IPåªæ˜¯ä¸€ä¸ªåè®®æ ˆï¼Œå°±åƒæ“ä½œç³»ç»Ÿçš„è¿è¡Œæœºåˆ¶ä¸€æ ·ï¼Œå¿…é¡»è¦å…·ä½“å®ç°ï¼ŒåŒæ—¶è¿˜è¦æä¾›å¯¹å¤–çš„æ“ä½œæ¥å£ã€‚è¿™ä¸ªå°±åƒæ“ä½œç³»ç»Ÿä¼šæä¾›æ ‡å‡†çš„ç¼–ç¨‹æ¥å£ï¼Œæ¯”å¦‚win32ç¼–ç¨‹æ¥å£ä¸€æ ·ï¼ŒTCP/IPä¹Ÿè¦æä¾›å¯ä¾›ç¨‹åºå‘˜åšç½‘ç»œå¼€å‘æ‰€ç”¨çš„æ¥å£ï¼Œè¿™å°±æ˜¯Socketç¼–ç¨‹æ¥å£ã€‚â€



### åŒºåˆ«

ä¸¤è€…æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå°±åƒé›·é”‹è·Ÿé›·é”‹å¡”ä¸€æ ·ã€‚



## WebSocketå’ŒHTTPæœ‰ä»€ä¹ˆåŒºåˆ«

![](./WebSocketå›¾ç‰‡/å¯¹æ¯”.jpg)

**ç›¸åŒç‚¹**

- éƒ½æ˜¯ä¸€æ ·åŸºäºTCPçš„ï¼Œéƒ½æ˜¯å¯é æ€§ä¼ è¾“åè®®

- éƒ½æ˜¯åº”ç”¨å±‚åè®®
- éƒ½ä½¿ç”¨Request/Responseæ¨¡å‹è¿›è¡Œè¿æ¥çš„å»ºç«‹
- åœ¨è¿æ¥çš„å»ºç«‹è¿‡ç¨‹ä¸­å¯¹é”™è¯¯çš„å¤„ç†æ–¹å¼ç›¸åŒï¼Œåœ¨è¿™ä¸ªé˜¶æ®µWSå¯èƒ½è¿”å›å’ŒHTTPç›¸åŒçš„è¿”å›ç 
- éƒ½å¯ä»¥åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®



**ä¸åŒç‚¹**

- WebSocketæ˜¯åŒå‘é€šä¿¡åè®®ï¼Œæ¨¡æ‹ŸSocketåè®®ï¼Œå¯ä»¥åŒå‘å‘é€æˆ–æ¥å—ä¿¡æ¯ã€‚HTTPæ˜¯å•å‘çš„ã€‚

- WebSocketæ˜¯éœ€è¦æ¡æ‰‹è¿›è¡Œå»ºç«‹è¿æ¥çš„(ç›¸å¯¹HTTPæ¥è¯´ï¼ŒWebSocketæ˜¯ä¸€ç§æŒä¹…åŒ–çš„åè®®ã€‚å®ƒä¼šåŸºäºHTTPåè®®ï¼Œæ¥å®Œæˆä¸€éƒ¨åˆ†æ¡æ‰‹ï¼ŒHTTPæ¡æ‰‹éƒ¨åˆ†å®Œæˆï¼Œåè®®å‡çº§ä¸ºWebSocket)ã€‚

- WSçš„è¿æ¥ä¸èƒ½é€šè¿‡ä¸­é—´äººæ¥è½¬å‘ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªç›´æ¥è¿æ¥
- WSè¿æ¥å»ºç«‹ä¹‹åï¼Œæ•°æ®çš„ä¼ è¾“ä½¿ç”¨å¸§æ¥ä¼ é€’ï¼Œä¸å†éœ€è¦Requestæ¶ˆæ¯

- WSçš„æ•°æ®å¸§æœ‰åº
- WSä½¿ç”¨HTTPæ¥å»ºç«‹è¿æ¥ï¼Œä½†æ˜¯å®šä¹‰äº†ä¸€ç³»åˆ—æ–°çš„headeråŸŸï¼Œè¿™äº›åŸŸåœ¨HTTPä¸­å¹¶ä¸ä¼šä½¿ç”¨





## è¿æ¥ä¿æŒ+å¿ƒè·³

**websocketå¿ƒè·³æœºåˆ¶ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªç‰¹æœ‰çš„å¿ƒè·³æ¶ˆæ¯ï¼Œæ¯æ¬¡æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯ååªéœ€å°†æ¶ˆæ¯è¿”å›ï¼Œæ­¤æ—¶ï¼Œè‹¥äºŒè€…è¿˜ä¿æŒè¿æ¥ï¼Œåˆ™å®¢æˆ·ç«¯å°±ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œè‹¥æ²¡æ”¶åˆ°ï¼Œåˆ™è¯´æ˜è¿æ¥æ–­å¼€ï¼Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±è¦ä¸»åŠ¨é‡è¿ï¼Œå®Œæˆä¸€ä¸ªå‘¨æœŸ**

ä½†ä¸æ’é™¤æœ‰äº›åœºæ™¯ï¼Œå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯è™½ç„¶é•¿æ—¶é—´æ²¡æœ‰æ•°æ®å¾€æ¥ï¼Œä½†ä»éœ€è¦ä¿æŒè¿æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å¿ƒè·³æ¥å®ç°ã€‚

- å‘é€æ–¹->æ¥æ”¶æ–¹ï¼šping
- æ¥æ”¶æ–¹->å‘é€æ–¹ï¼špong

pingã€pongçš„æ“ä½œï¼Œå¯¹åº”çš„æ˜¯WebSocketçš„ä¸¤ä¸ªæ§åˆ¶å¸§ï¼Œ`opcode`åˆ†åˆ«æ˜¯`0x9`ã€`0xA`ã€‚

ä¸¾ä¾‹ï¼ŒWebSocketæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€pingï¼Œåªéœ€è¦å¦‚ä¸‹ä»£ç ï¼ˆé‡‡ç”¨`ws`æ¨¡å—ï¼‰

```javascript
ws.ping('', false, true);
```

**å¯¹äºå‰ç«¯ï¼š**

å¦‚æœè®¾å¤‡ç½‘ç»œæ–­å¼€ï¼Œä¸ä¼šç«‹åˆ»è§¦å‘ Websocket çš„ä»»ä½•äº‹ä»¶ï¼Œå‰ç«¯ä¹Ÿå°±æ— æ³•å¾—çŸ¥å½“å‰è¿æ¥æ˜¯å¦å·²ç»æ–­å¼€ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœè°ƒç”¨ `Websocket.send` æ–¹æ³•ï¼Œæµè§ˆå™¨æ‰ä¼šå‘ç°é“¾æ¥æ–­å¼€äº†ï¼Œä¾¿ä¼šç«‹åˆ»æˆ–è€…ä¸€å®šæ—¶é—´åï¼ˆä¸åŒæµè§ˆå™¨æˆ–è€…æµè§ˆå™¨ç‰ˆæœ¬å¯èƒ½è¡¨ç°ä¸åŒï¼‰è§¦å‘ onclose å‡½æ•°ã€‚

**å¯¹äºåç«¯ï¼š**

åç«¯ Websocket æœåŠ¡ä¹Ÿå¯èƒ½å‡ºç°å¼‚å¸¸ï¼Œé€ æˆè¿æ¥æ–­å¼€ï¼Œè¿™æ—¶å‰ç«¯ä¹Ÿå¹¶æ²¡æœ‰æ”¶åˆ°æ–­å¼€é€šçŸ¥ï¼Œå› æ­¤éœ€è¦å‰ç«¯å®šæ—¶å‘é€å¿ƒè·³æ¶ˆæ¯ pingï¼Œåç«¯æ”¶åˆ° ping ç±»å‹çš„æ¶ˆæ¯ï¼Œç«‹é©¬è¿”å›æ¶ˆæ¯ï¼Œå‘ŠçŸ¥å‰ç«¯è¿æ¥æ­£å¸¸ã€‚å¦‚æœä¸€å®šæ—¶é—´æ²¡æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±è¯´æ˜è¿æ¥ä¸æ­£å¸¸ï¼Œå‰ç«¯ä¾¿ä¼šæ‰§è¡Œé‡è¿ã€‚

**ä¿è¯è¿æ¥çŠ¶æ€ï¼Œè¿æ¥æ–­å¼€æ—¶è®©å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯éƒ½èƒ½çŸ¥é“ï¼Œè¿›è€Œé‡è¿ã€‚**



## å³æ—¶é€šè®¯çš„ 4 ç§å®ç°æ–¹æ¡ˆ

### æ¦‚è§ˆ

**å³æ—¶é€šè®¯çš„å®ç°ï¼šçŸ­è½®è¯¢ã€é•¿è½®è¯¢ã€SSE å’Œ WebSocket**

çŸ­è½®è¯¢å’Œé•¿è½®è¯¢çš„ç›®çš„éƒ½æ˜¯ç”¨äºå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ä¸€ä¸ªå³æ—¶é€šè®¯ã€‚

**çŸ­è½®è¯¢çš„åŸºæœ¬æ€è·¯(ajaxè½®è¯¢)ï¼š** æµè§ˆå™¨æ¯éš”ä¸€æ®µæ—¶é—´å‘æµè§ˆå™¨å‘é€ http è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¸è®ºæ˜¯å¦æœ‰æ•°æ®æ›´æ–°ï¼Œéƒ½ç›´æ¥è¿›è¡Œå“åº”ã€‚è¿™ç§æ–¹å¼å®ç°çš„å³æ—¶é€šä¿¡ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯æµè§ˆå™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥å—è¯·æ±‚çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œé€šè¿‡è®©å®¢æˆ·ç«¯ä¸æ–­çš„è¿›è¡Œè¯·æ±‚ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿæ¨¡æ‹Ÿå®æ—¶åœ°æ”¶åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®çš„å˜åŒ–ã€‚è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒç®€å•ï¼Œæ˜“äºç†è§£ã€‚ç¼ºç‚¹æ˜¯è¿™ç§æ–¹å¼ç”±äºéœ€è¦ä¸æ–­çš„å»ºç«‹ http è¿æ¥ï¼Œä¸¥é‡æµªè´¹äº†æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„èµ„æºã€‚å½“ç”¨æˆ·å¢åŠ æ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„å‹åŠ›å°±ä¼šå˜å¤§ï¼Œè¿™æ˜¯å¾ˆä¸åˆç†çš„ã€‚

**é•¿è½®è¯¢çš„åŸºæœ¬æ€è·¯ï¼š** é¦–å…ˆç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚åï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šç›´æ¥è¿›è¡Œå“åº”ï¼Œè€Œæ˜¯å…ˆå°†è¿™ä¸ªè¯·æ±‚æŒ‚èµ·ï¼Œç„¶ååˆ¤æ–­æœåŠ¡å™¨ç«¯æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ã€‚å¦‚æœæœ‰æ›´æ–°ï¼Œåˆ™è¿›è¡Œå“åº”ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ•°æ®ï¼Œåˆ™åˆ°è¾¾ä¸€å®šçš„æ—¶é—´é™åˆ¶æ‰è¿”å›ã€‚å®¢æˆ·ç«¯ JavaScript å“åº”å¤„ç†å‡½æ•°ä¼šåœ¨å¤„ç†å®ŒæœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯åï¼Œå†æ¬¡å‘å‡ºè¯·æ±‚ï¼Œé‡æ–°å»ºç«‹è¿æ¥ã€‚é•¿è½®è¯¢å’ŒçŸ­è½®è¯¢æ¯”èµ·æ¥ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯æ˜æ˜¾å‡å°‘äº†å¾ˆå¤šä¸å¿…è¦çš„ http è¯·æ±‚æ¬¡æ•°ï¼Œç›¸æ¯”ä¹‹ä¸‹èŠ‚çº¦äº†èµ„æºã€‚é•¿è½®è¯¢çš„ç¼ºç‚¹åœ¨äºï¼Œè¿æ¥æŒ‚èµ·ä¹Ÿä¼šå¯¼è‡´èµ„æºçš„æµªè´¹ã€‚

**SSE çš„åŸºæœ¬æ€æƒ³ï¼š** æœåŠ¡å™¨ä½¿ç”¨æµä¿¡æ¯å‘æœåŠ¡å™¨æ¨é€ä¿¡æ¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œhttp åè®®æ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€çš„ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¼šè¿ç»­ä¸æ–­åœ°å‘é€è¿‡æ¥ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚SSE å°±æ˜¯åˆ©ç”¨è¿™ç§æœºåˆ¶ï¼Œä½¿ç”¨æµä¿¡æ¯å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯ã€‚å®ƒåŸºäº http åè®®ï¼Œç›®å‰é™¤äº† IE/Edgeï¼Œå…¶ä»–æµè§ˆå™¨éƒ½æ”¯æŒã€‚å®ƒç›¸å¯¹äºå‰é¢ä¸¤ç§æ–¹å¼æ¥è¯´ï¼Œä¸éœ€è¦å»ºç«‹è¿‡å¤šçš„ http è¯·æ±‚ï¼Œç›¸æ¯”ä¹‹ä¸‹èŠ‚çº¦äº†èµ„æºã€‚

**WebSocket** æ˜¯ HTML5 å®šä¹‰çš„ä¸€ä¸ªæ–°åè®®è®®ï¼Œä¸ä¼ ç»Ÿçš„ http åè®®ä¸åŒï¼Œè¯¥åè®®å…è®¸ç”±æœåŠ¡å™¨ä¸»åŠ¨çš„å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚ä½¿ç”¨ WebSocket åè®®çš„ç¼ºç‚¹æ˜¯åœ¨æœåŠ¡å™¨ç«¯çš„é…ç½®æ¯”è¾ƒå¤æ‚ã€‚WebSocket æ˜¯ä¸€ä¸ªå…¨åŒå·¥çš„åè®®ï¼Œä¹Ÿå°±æ˜¯é€šä¿¡åŒæ–¹æ˜¯å¹³ç­‰çš„ï¼Œå¯ä»¥ç›¸äº’å‘é€æ¶ˆæ¯ï¼Œè€Œ SSE çš„æ–¹å¼æ˜¯å•å‘é€šä¿¡çš„ï¼Œåªèƒ½ç”±æœåŠ¡å™¨ç«¯å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå¦‚æœå®¢æˆ·ç«¯éœ€è¦å‘é€ä¿¡æ¯å°±æ˜¯å±äºä¸‹ä¸€ä¸ª http è¯·æ±‚äº†ã€‚

**ä¸Šé¢çš„å››ä¸ªé€šä¿¡åè®®ï¼Œå‰ä¸‰ä¸ªéƒ½æ˜¯åŸºäºHTTPåè®®çš„ã€‚**

å¯¹äºè¿™å››ç§å³ä½¿é€šä¿¡åè®®ï¼Œä»æ€§èƒ½çš„è§’åº¦æ¥çœ‹ï¼š **WebSocket > é•¿è¿æ¥ï¼ˆSEEï¼‰ > é•¿è½®è¯¢ > çŸ­è½®è¯¢** ä½†æ˜¯ï¼Œæˆ‘ä»¬å¦‚æœè€ƒè™‘æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ï¼Œé¡ºåºå°±æ°æ°ç›¸åäº†ï¼š **çŸ­è½®è¯¢ > é•¿è½®è¯¢ > é•¿è¿æ¥ï¼ˆSEEï¼‰ > WebSocket** æ‰€ä»¥ï¼Œè¿˜æ˜¯è¦æ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºæ™¯æ¥åˆ¤æ–­ä½¿ç”¨å“ªç§æ–¹å¼ã€‚



### çŸ­è½®è¯¢

```js
// ç¼“å­˜å‰ç«¯å·²ç»è·å–çš„æœ€æ–°id
let id = 0;

function poll() {
  $.ajax({
    url: '/api/polling',
    data: { id },
    }).done(res => {
      id += res.length;
    }).always(() => {
      // 10såå†æ¬¡è¯·æ±‚
      setTimeout(poll, 10000);
    });
}

poll();
```



### SSE

è½®è¯¢ã€é•¿è½®è¯¢éƒ½æ˜¯ä¸€é—®ä¸€ç­”å¼çš„ï¼Œä¸€æ¬¡è¯·æ±‚ï¼Œæ— æ³•æ¨é€å¤šæ¬¡æ¶ˆæ¯åˆ°å‰ç«¯ã€‚è€ŒSSEå°±å‰å®³äº†ï¼Œ**ä¸€æ¬¡è¯·æ±‚ï¼ŒNæ¬¡æ¨é€**ã€‚

å…¶åŸç†ï¼Œæˆ–è€…è¯´ç±»æ¯”ï¼Œ**ä¸ªäººè®¤ä¸ºå¯ä»¥ç†è§£ä¸ºä¸‹è½½ä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹åˆ†å—ä¼ ç»™å‰ç«¯ï¼Œæ¯å—å°±æ˜¯ä¸€æ¬¡æ¶ˆæ¯æ¨é€**ã€‚

> `SSE` åªèƒ½æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€æ•°æ®

HTTP åè®®æ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ï¼ˆstreamingï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€çš„ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¼šè¿ç»­ä¸æ–­åœ°å‘é€è¿‡æ¥ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ç§é€šä¿¡å°±æ˜¯ä»¥æµä¿¡æ¯çš„æ–¹å¼ï¼Œå®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿çš„ä¸‹è½½ã€‚

> æ‰€è°“SSEï¼ˆSever-Sent Eventï¼‰ï¼Œå°±æ˜¯æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œä¿æŒé•¿è¿æ¥ï¼ŒæœåŠ¡å™¨ä¸æ–­å•å‘åœ°å‘æµè§ˆå™¨æ¨é€â€œä¿¡æ¯â€ï¼ˆmessageï¼‰ï¼Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†èŠ‚çº¦ç½‘ç»œèµ„æºï¼Œä¸ç”¨ä¸€ç›´å‘è¯·æ±‚ï¼Œå»ºç«‹æ–°è¿æ¥ã€‚

çœ‹äº†æ¦‚å¿µä½ å°±ä¼šå‘ç°ï¼Œä»–å…¶å®å°±æ˜¯ç±»ä¼¼é•¿è½®è¯¢ï¼Œä»–æœ‰ä¸€ä¸ªæµè§ˆå™¨å†…ç½®EventSourceå¯¹è±¡æ¥æ“ä½œ

```go
//è¿›å»ºç«‹é“¾æ¥
var source = new EventSource();
//å…³é—­é“¾æ¥
source.close();
```



**å®Œæ•´ä»£ç **

å®¢æˆ·ç«¯

`H5`ç«¯ä½¿ç”¨`EventSource`å¯¹è±¡ï¼Œå¡«å…¥è¦è¯·æ±‚çš„`url`åœ°å€å°±å¯ä»¥äº†ã€‚

```javascript
var source = new EventSource('/api', {
    withCredentials: true
});
source.onopen = function () {
    console.log('é“¾æ¥å·²å»ºç«‹', this.readyState);
}
source.onmessage = function (event) {
    console.log('å®æ—¶è·å–çš„æ•°æ®', event.data);
}
source.onerror = function () {
    console.log('å‘ç”Ÿé”™è¯¯');
}
// å…³é—­
// source.close();
```

æœåŠ¡ç«¯

æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€çš„ `SSE` æ•°æ®ï¼Œé¦–å…ˆå¿…é¡»è®¾ç½®å“åº”å¤´çš„`Content-type`ä¸º`text/event-stream`ï¼Œä¸”ç¼–ç æ ¼å¼ä¸º`utf-8`ã€‚è¿”å›çš„æ•°æ®æ ¼å¼å¿…é¡»ä¸º`data: xxxx\n\n`ã€‚é™¤äº†`data`è¿˜æœ‰`event`ï¼Œ`id`ï¼Œä»¥åŠ`retry`.

```javascript
const http = require('http');
const fs = require('fs');

const app = http.createServer((req, res) => {
    res.setHeader('Content-type', 'text/event-stream; charset=utf-8'); //æ ¸å¿ƒï¼šè¦è®©å‰ç«¯çŸ¥é“è¿™æ˜¯SSE
    res.setHeader('Cache-Control', 'max-age=0'); // æ¸…æ¥šç¼“å­˜
    res.setHeader('Access-Control-Allow-Origin', 'http:127.0.0.1/');
    let num = 0;
    const send = () => {
        if (num > 20) {
            res.end();
            return;
        }
        num++;
        const data = Math.random() + '';
        res.write(`data: ${data}\n\n`, 'utf8');
        setTimeout(send, 1000);
    }
    send();
});

app.listen(8081, () => {
    console.log('127.0.0.1:8081');
})
```





### Websocket

å‰ç«¯ä»£ç å¦‚ä¸‹:

```js
const sock = io.connect('ws://127.0.0.1:8080/api');
sock.on('connect', () => {
    console.log('å·²é“¾æ¥');
    sock.emit('aaa', 12, 5,8);
    sock.on('time', (ts) => {
        console.loh(ts);
    })
});
sock.on('disconnect', () => {
    console.log('å·²æ–­å¼€');
});
```

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```js
const http = require('http');
const io = require('socket.io');

// åˆ›å»ºhttpæœåŠ¡ï¼Œå¼€å¯8080ç«¯å£å·
const httpServer = http.createServer().listen(8080);
// socketç›‘å¬httpæœåŠ¡
const wsServer = io.listen(httpServer);

// å½“æœ‰é“¾æ¥çš„æ—¶å€™
wsServer.on('connection', sock => {
    // å‘é€
    // sock.emit
    sock.emit('time', Date.now());
    // æ¥æ”¶
    sock.on('aaa', (a, b, c) => {
        console.loh(a, b, c);
    })
})
```





å‚è€ƒæ–‡ç« ï¼š

[å‰ç«¯é¢è¯•é¢˜:ä½ çŸ¥é“websocketå—?](https://juejin.cn/post/6844903815913668621#heading-8)

[ã€ä¸¥é€‰-é«˜è´¨é‡æ–‡ç« ã€‘å¼€å‘è€…å¿…çŸ¥å¿…ä¼šçš„ WebSocket åè®®](https://juejin.cn/post/6844903909148868621#heading-4)

[å¸¦ä½ æ­å¼€WebSocketçš„ç¥ç§˜é¢çº±ï¼](https://juejin.cn/post/6844903972835164173#heading-9)

[è¿™æ˜¯å³æ—¶é€šè®¯çš„ 4 ç§å®ç°æ–¹æ¡ˆ](https://juejin.cn/post/7057687288154685470#heading-2)

[é¢è¯•å®˜ï¼šæœåŠ¡ç«¯æ¨é€åˆ°Webå‰ç«¯æœ‰å“ªå‡ ç§æ–¹å¼ï¼Ÿ](https://juejin.cn/post/7113813187727720461)