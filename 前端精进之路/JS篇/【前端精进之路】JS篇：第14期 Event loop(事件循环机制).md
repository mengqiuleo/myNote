[TOC]



## å†™åœ¨å‰é¢

è¿™é‡Œæ˜¯å°é£ä¾ PanğŸ¥³ï¼Œç«‹å¿—æˆä¸ºä¸€åä¼˜ç§€çš„å‰ç«¯ç¨‹åºåª›ï¼ï¼ï¼

æœ¬ç¯‡æ–‡ç« æ”¶å½•äºæˆ‘çš„ä¸“æ ï¼š[å‰ç«¯ç²¾è¿›ä¹‹è·¯](https://blog.csdn.net/weixin_52834435/category_11886356.html?spm=1001.2014.3001.5482)

åŒæ—¶æ”¶å½•äºæˆ‘çš„[github](https://github.com/mengqiuleo)å‰ç«¯ç¬”è®°ä»“åº“ä¸­ï¼ŒæŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿star~

ğŸ‘‰[https://github.com/mengqiuleo/myNote](https://github.com/mengqiuleo/myNote)

<hr>

## ä¸€ã€æµè§ˆå™¨ä¸­çš„Event Loop

### å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

å¯ä»¥ç†è§£æ˜¯æ¯æ¬¡æ‰§è¡Œæ ˆæ‰§è¡Œçš„ä»£ç å°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ¯æ¬¡ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªäº‹ä»¶å›è°ƒå¹¶æ”¾åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼‰ã€‚

åŒ…æ‹¬ script å…¨éƒ¨ä»£ç ã€setTimeoutã€setIntervalã€setImmediateï¼ˆNode.jsï¼‰ã€requestAnimationFrameï¼ˆæµè§ˆå™¨ï¼‰ã€I/O æ“ä½œã€UI æ¸²æŸ“ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œè¿™äº›ä»£ç æ‰§è¡Œä¾¿æ˜¯å®ä»»åŠ¡ã€‚

- æ¯ä¸€ä¸ªtaskä¼šä»å¤´åˆ°å°¾å°†è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸ä¼šæ‰§è¡Œå…¶å®ƒ
- æµè§ˆå™¨ä¸ºäº†èƒ½å¤Ÿä½¿å¾—JSå†…éƒ¨taskä¸DOMä»»åŠ¡èƒ½å¤Ÿæœ‰åºçš„æ‰§è¡Œï¼Œä¼šåœ¨ä¸€ä¸ªtaskæ‰§è¡Œç»“æŸåï¼Œåœ¨ä¸‹ä¸€ä¸ª task æ‰§è¡Œå¼€å§‹å‰ï¼Œå¯¹é¡µé¢è¿›è¡Œé‡æ–°æ¸²æŸ“

```
ï¼ˆ`task->æ¸²æŸ“->task->...`ï¼‰
```



å¸¸è§å®ä»»åŠ¡ï¼š

**äº‹ä»¶é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªäº‹ä»¶éƒ½æ˜¯ä¸€ä¸ªmacrotask**

- setTimeout()

- setInterval()

- setImmediate()
- å¸¸è§çš„ç‚¹å‡»å’Œé”®ç›˜ç­‰äº‹ä»¶
- ä¸»ä»£ç å—

å¸¸è§å¾®ä»»åŠ¡ï¼š

- promise.then()ã€promise.catch()

- new MutaionObserver()

- process.nextTick()



### æ‰§è¡Œè¿‡ç¨‹ï¼š

åœ¨æµè§ˆå™¨çš„å¼‚æ­¥å›è°ƒé˜Ÿåˆ—ä¸­ï¼Œå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. **å®ä»»åŠ¡é˜Ÿåˆ—ä¸€æ¬¡åªä»é˜Ÿåˆ—ä¸­å–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ**ï¼Œæ‰§è¡Œå®Œåå°±å»æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
2. å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«ä¾æ¬¡å–å‡ºæ¥æ‰§è¡Œï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚

3. åœ¨æ‰§è¡Œå®Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ä¹‹åï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ä¹‹å‰ï¼Œæµè§ˆå™¨ä¼šæ‰§è¡Œ UI æ¸²æŸ“æ“ä½œã€æ›´æ–°ç•Œé¢ã€‚

**å¾®ä»»åŠ¡æ˜¯åœ¨å½“å‰äº‹ä»¶å¾ªç¯çš„å°¾éƒ¨å»æ‰§è¡Œï¼›å®ä»»åŠ¡æ˜¯åœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„å¼€å§‹å»æ‰§è¡Œã€‚**



### async/await(å¾®ä»»åŠ¡)æ‰§è¡Œé¡ºåº

> async/awaitæˆå¯¹å‡ºç°ï¼Œasyncæ ‡è®°çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨thenæ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚åœ¨awaitä¹‹å‰çš„è¯­å¥ï¼Œawaitåé¢çš„è¯­å¥ä¼šåŒæ­¥æ‰§è¡Œã€‚ä½† await ä¸‹é¢çš„è¯­å¥ä¼šè¢«å½“æˆ**å¾®ä»»åŠ¡**æ·»åŠ åˆ°å½“å‰ä»»åŠ¡é˜Ÿåˆ—çš„æœ«å°¾å¼‚æ­¥æ‰§è¡Œã€‚

#### ä¸€ä¸ªdemo

```js
async function async1(){
    console.log('async1 start')
    await async2()
    console.log('async1 end')
}
async function async2(){
    console.log('async2')
}
console.log('script start')
setTimeout(function(){
    console.log('setTimeout') 
},0)  
async1();
new Promise(function(resolve){
    console.log('promise1')
    resolve();
}).then(function(){
    console.log('promise2')
})
console.log('script end')
```

æ‰“å°ç»“æœä¸ºï¼š

```
script start --> async1 start --> async2 --> promise1 --> script end --> async1 end
--> promise2 --> setTimeout
```

åˆ†æï¼š

- å…ˆå®šä¹‰å‡½æ•°async1ï¼Œasync2ã€‚è¾“å‡ºåŒæ­¥ä»£ç  `script start`
- å°†`setTimeout`é‡Œé¢çš„å›è°ƒå‡½æ•°(å®ä»»åŠ¡)æ·»åŠ åˆ°ä¸‹ä¸€è½®ä»»åŠ¡é˜Ÿåˆ—ã€‚å› ä¸ºè¿™æ®µä»£ç å‰é¢æ²¡æœ‰æ‰§è¡Œä»»ä½•çš„å¼‚æ­¥æ“ä½œä¸”ç­‰å¾…æ—¶é—´ä¸º0sã€‚æ‰€ä»¥å›è°ƒå‡½æ•°ä¼šè¢«ç«‹åˆ»æ”¾åˆ°ä¸‹ä¸€è½®ä»»åŠ¡é˜Ÿåˆ—çš„å¼€å¤´ã€‚
- æ‰§è¡Œ`async1`ï¼Œå› ä¸ºasyncå‡½æ•°é‡Œé¢awaitæ ‡è®°ä¹‹å‰çš„è¯­å¥å’Œ await åé¢çš„è¯­å¥æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆåè¾“å‡º`async1 start`ï¼Œ`async2`ã€‚
- è¿™æ—¶æš‚åœæ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œç›¸å½“äºå˜æˆä¸€ä¸ªpromise.thenï¼Œä¸‹é¢çš„è¯­å¥è¢«æ”¾åˆ°å½“å‰é˜Ÿåˆ—çš„æœ€åã€‚
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚
- è¾“å‡º`Promise1`ã€‚å°†thené‡Œé¢çš„å‡½æ•°æ”¾åœ¨å½“å‰é˜Ÿåˆ—çš„æœ€åã€‚
- ç„¶åè¾“å‡º`script end`ï¼Œæ­¤æ—¶åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ªå¾®ä»»åŠ¡ã€‚é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºçš„ç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆè¾“å‡º`async1 end`ï¼Œå†è¾“å‡º`Promise2`ã€‚
- ç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ‰§è¡Œ`setTimeout`é‡Œé¢çš„å¼‚æ­¥å‡½æ•°ã€‚è¾“å‡º`setTimout`ã€‚



#### å¦ä¸€ä¸ªdemo

```js
console.log('script start')

async function async1() {
    await async2()
    console.log('async1 end')
}
async function async2() {
    console.log('async2 end')
    return Promise.resolve().then(()=>{
        console.log('async2 end1')
    })
}
async1()

setTimeout(function() {
    console.log('setTimeout')
}, 0)

new Promise(resolve => {
    console.log('Promise')
    resolve()
})
.then(function() {
    console.log('promise1')
})
.then(function() {
    console.log('promise2')
})

console.log('script end')
```

æ‰“å°ç»“æœï¼š

```js
script start
async2 end
Promise
script end
async2 end1
promise1
promise2
async1 end
setTimeout
```

**åˆ†æï¼š**

- é¦–å…ˆè¾“å‡º`script start`,å®šä¹‰å‡½æ•°ï¼šasync1ï¼Œasync2ã€‚ç„¶åæ‰§è¡Œasync1()
- åœ¨async1()é¦–å…ˆä¼šè¿›å…¥åˆ°async2()ä¸­ï¼Œè¾“å‡º`async2 end`ã€‚ç„¶åasync2è¿”å›çš„æ˜¯ä¸€ä¸ªpromiseå¾®ä»»åŠ¡ï¼Œæ‰€ä»¥å°†`async2 end1`æ”¾å…¥é˜Ÿåˆ—ï¼Œæ³¨æ„ï¼šæ­¤æ—¶`ä¿ç•™async1å‡½æ•°çš„ä¸Šä¸‹æ–‡ï¼ˆ è¿™é‡Œå¹¶ä¸ä¼šåŠ¨ await ä¸‹é¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå°†å®ƒå˜æˆä¸€ä¸ªå¾®ä»»åŠ¡ ï¼‰`ï¼Œå› ä¸ºawaitåé¢çš„è¯­å¥æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä½†æ˜¯è¦ç­‰åˆ°awaitåé¢çš„è¯­å¥æœ‰äº†è¿”å›å€¼ï¼Œæ‰èƒ½æŠŠä¸‹é¢çš„è¯­å¥æ”¾å…¥å¾®ä»»åŠ¡
- ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå°†setTimeoutæ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—
- æ‰§è¡Œpromiseä¸­çš„åŒæ­¥ä»£ç `Promise`ï¼Œç„¶åå°†`promise1`æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ³¨æ„ï¼šæ­¤æ—¶å¹¶ä¸ä¼šå°†`promise2`æ”¾å…¥é˜Ÿåˆ—ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸‹å°†æ‰€æœ‰çš„éƒ½æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯ç­‰åˆ°ä¸Šä¸€ä¸ªthenæœ‰äº†è¿”å›å€¼æ‰ä¼šå°†ä¸‹ä¸€ä¸ªthenæ”¾å…¥é˜Ÿåˆ—ã€‚
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç `script end`ã€‚æ­¤æ—¶å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—
- é¦–å…ˆè¾“å‡º`async2 end`ï¼Œç„¶åæ­¤æ—¶å¹¶ä¸ä¼šå›åˆ°async1()ï¼Œasync1()æ˜¯å±äºä¸‹ä¸€è½®çš„å¾®ä»»åŠ¡äº†ã€‚
- æ­¤æ—¶ä¼šæ‰§è¡Œ`promise1`ï¼Œç„¶åè¿™ä¸ªpromiseæœ‰äº†è¿”å›å€¼ï¼Œå°†`promise2`åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- ç„¶åå–å‡ºå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„`promise2`æ‰§è¡Œã€‚ç„¶åæ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º
- ç„¶å`å›åˆ°async1å‡½æ•°ï¼Œå¹¶å°†awaitåé¢çš„ä»£ç æ³¨å†Œä¸ºå¾®ä»»åŠ¡å¹¶æ‰§è¡Œ`ã€‚
- æœ€åæ‰§è¡Œé‚£ä¸ªå®ä»»åŠ¡ã€‚



#### äºŒè€…å¯¹æ¯”

åˆ†æï¼š

ç¬¬äºŒä¸ªä¾‹å­å’Œä¸Šé¢çš„ç¬¬ä¸€ä¸ªä¾‹å­çš„åŒºåˆ«æ˜¯ï¼š

- ç¬¬ä¸€ä¸ªä¾‹å­çš„await åé¢è·Ÿçš„æ˜¯ä¸€ä¸ªç›´æ¥å˜é‡ï¼Œè¿™ç§æƒ…å†µç›´æ¥ç›¸å½“äº`æŠŠawaitä¸‹é¢çš„ä»£ç æ³¨å†Œä¸ºpromise.then(ä¸€ä¸ªå¾®ä»»åŠ¡)`ã€‚ç„¶åè·³å‡ºasync1å‡½æ•°ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œå…¶ä»–ä»£ç ã€‚
- ç¬¬äºŒä¸ªä¾‹å­æ˜¯awaitåé¢è·Ÿçš„æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°çš„è°ƒç”¨ï¼Œæ­¤æ—¶`å°†è¿™ä¸ªå¼‚æ­¥å‡½æ•°æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—`ï¼Œç„¶å`ä¿ç•™async1å‡½æ•°çš„ä¸Šä¸‹æ–‡ï¼ˆ è¿™é‡Œå¹¶ä¸ä¼šåŠ¨ await ä¸‹é¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå°†å®ƒå˜æˆä¸€ä¸ªå¾®ä»»åŠ¡ ï¼‰`ï¼Œæ‰§è¡Œå…¶ä»–åŒæ­¥ä»£ç ï¼Œå½“åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œæ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ˜¯async2å‡½æ•°é‡Œçš„å¼‚æ­¥ï¼Œå–å‡ºå¹¶æ‰§è¡Œï¼Œ**ç„¶åæ‰§è¡Œpromiseæ”¾å…¥çš„ä¸¤ä¸ªå¾®ä»»åŠ¡**ã€‚ç›®å‰å¾®ä»»åŠ¡é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼Œç„¶å`å›åˆ°async1å‡½æ•°ï¼Œå¹¶å°†awaitåé¢çš„ä»£ç æ³¨å†Œä¸ºå¾®ä»»åŠ¡å¹¶æ‰§è¡Œ`ã€‚æœ€åæ‰§è¡Œé‚£ä¸ªå®ä»»åŠ¡ã€‚



## äºŒã€Node ä¸­çš„ Event Loop

> åœ¨nodeä¸­ï¼Œé¦–å…ˆä¼šå¼€å¯ä¸€ä¸ªnodeè¿›ç¨‹ï¼Œnodeè¿›ç¨‹ä¹Ÿæ˜¯å¤šçº¿ç¨‹çš„
>
> å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯jsçº¿ç¨‹ï¼Œç”¨æ¥æ‰§è¡Œjsä»£ç 
>
> å…¶ä»–çº¿ç¨‹ç”¨æ¥æ‰§è¡Œ I/Oæ“ä½œï¼ŒsetTimeoutï¼Œç½‘ç»œè¯·æ±‚

Node.jsçš„è¿è¡Œæœºåˆ¶å¦‚ä¸‹:

- V8å¼•æ“è§£æJavaScriptè„šæœ¬ã€‚
- è§£æåçš„ä»£ç ï¼Œè°ƒç”¨Node APIã€‚
- libuvåº“è´Ÿè´£Node APIçš„æ‰§è¡Œã€‚å®ƒå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ªEvent Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™V8å¼•æ“ã€‚
- V8å¼•æ“å†å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚



### äº‹ä»¶å¾ªç¯å„é˜¶æ®µ

![](./å›¾ç‰‡/äº‹ä»¶å¾ªç¯.jpg)

**æ‰§è¡Œçš„å‡ ä¸ªé˜¶æ®µ**

1. **timers é˜¶æ®µï¼šæ‰§è¡Œ timers çš„å›è°ƒï¼Œä¹Ÿæ˜¯æ‰§è¡Œ setTimeout å’Œ setInterval çš„å›è°ƒ**
2. pending IO callbacksï¼šç³»ç»Ÿæ“ä½œçš„å›è°ƒ
3. idleï¼Œpepareï¼šå†…éƒ¨ä½¿ç”¨
4. **pollï¼šç­‰å¾…æ–°çš„ I/O äº‹ä»¶è¿›æ¥**
5. **checkï¼šæ‰§è¡Œ setImmediate å›è°ƒ**
6. close callbacksï¼šå†…éƒ¨ä½¿ç”¨

**åªéœ€å…³æ³¨ 1ã€4ã€5 é˜¶æ®µ**



#### timeré˜¶æ®µ

**timersé˜¶æ®µæœ‰å‡ ä¸ªsetTimeout/setIntervaléƒ½ä¼šä¾æ¬¡æ‰§è¡Œ**ï¼Œå¹¶ä¸åƒæµè§ˆå™¨ç«¯ï¼Œæ¯æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡åå°±å»æ‰§è¡Œä¸€ä¸ªå¾®ä»»åŠ¡

```js
console.log('start')
setTimeout(() => {
  console.log('timer1')
  Promise.resolve().then(function() {
    console.log('promise1')
  })
}, 0)
setTimeout(() => {
  console.log('timer2')
  Promise.resolve().then(function() {
    console.log('promise2')
  })
}, 0)
Promise.resolve().then(function() {
  console.log('promise3')
})
console.log('end')
//start=>end=>promise3=>timer1=>timer2=>promise1=>promise2
```



#### pollé˜¶æ®µ

poll æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é˜¶æ®µï¼Œè¿™ä¸€é˜¶æ®µä¸­ï¼Œç³»ç»Ÿä¼šåšä¸¤ä»¶äº‹æƒ…

1.å›åˆ° timer é˜¶æ®µæ‰§è¡Œå›è°ƒ

2.æ‰§è¡Œ I/O å›è°ƒ

å¹¶ä¸”åœ¨è¿›å…¥è¯¥é˜¶æ®µæ—¶å¦‚æœæ²¡æœ‰è®¾å®šäº† timer çš„è¯ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹ä¸¤ä»¶äº‹æƒ…

- å¦‚æœ poll é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¼šéå†å›è°ƒé˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¾¾åˆ°ç³»ç»Ÿé™åˆ¶
- å¦‚æœ poll é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šæœ‰ä¸¤ä»¶äº‹å‘ç”Ÿ
  - å¦‚æœæœ‰ setImmediate å›è°ƒéœ€è¦æ‰§è¡Œï¼Œpoll é˜¶æ®µä¼šåœæ­¢å¹¶ä¸”è¿›å…¥åˆ° check é˜¶æ®µæ‰§è¡Œå›è°ƒ
  - å¦‚æœæ²¡æœ‰ setImmediate å›è°ƒéœ€è¦æ‰§è¡Œï¼Œä¼šç­‰å¾…å›è°ƒè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶ç«‹å³æ‰§è¡Œå›è°ƒï¼Œè¿™é‡ŒåŒæ ·ä¼šæœ‰ä¸ªè¶…æ—¶æ—¶é—´è®¾ç½®é˜²æ­¢ä¸€ç›´ç­‰å¾…ä¸‹å»

å½“ç„¶è®¾å®šäº† timer çš„è¯ä¸” poll é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ timer è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå›åˆ° timer é˜¶æ®µæ‰§è¡Œå›è°ƒã€‚





### setImmediate å’Œ setTimeout

- setImmediate è®¾è®¡åœ¨pollé˜¶æ®µå®Œæˆæ—¶æ‰§è¡Œï¼Œå³checké˜¶æ®µï¼›
- setTimeout è®¾è®¡åœ¨pollé˜¶æ®µä¸ºç©ºé—²æ—¶ï¼Œä¸”è®¾å®šæ—¶é—´åˆ°è¾¾åæ‰§è¡Œï¼Œä½†å®ƒåœ¨timeré˜¶æ®µæ‰§è¡Œ

**æ‰§è¡Œå®šæ—¶å™¨çš„é¡ºåºå°†æ ¹æ®è°ƒç”¨å®ƒä»¬çš„ä¸Šä¸‹æ–‡è€Œæœ‰æ‰€ä¸åŒã€‚ å¦‚æœä»ä¸»æ¨¡å—ä¸­è°ƒç”¨ä¸¤è€…ï¼Œé‚£ä¹ˆæ—¶é—´å°†å—åˆ°è¿›ç¨‹æ€§èƒ½çš„é™åˆ¶ã€‚**

#### demo1

```js
console.log('outer');

setTimeout(() => {
  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
  setImmediate(() => {
    console.log('setImmediate');
  });
}, 0);
```

è¿è¡Œç»“æœï¼š

```js
outer
setImmediate
setTimeout
```

è§£é‡Šï¼š

- é¦–å…ˆæœ€å¤–é¢æ˜¯ä¸€ä¸ªsetTimeoutï¼Œæ‰€ä»¥æ‰§è¡Œå½“å‰çš„å›è°ƒçš„æ—¶å€™å·²ç»åœ¨`timers`é˜¶æ®µäº†
- å¤„ç†é‡Œé¢çš„`setTimeout`ï¼Œå› ä¸ºæœ¬æ¬¡å¾ªç¯çš„`timers`æ­£åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥ä»–çš„å›è°ƒå…¶å®åŠ åˆ°äº†ä¸‹ä¸ª`timers`é˜¶æ®µ
- å¤„ç†é‡Œé¢çš„`setImmediate`ï¼Œå°†å®ƒçš„å›è°ƒåŠ å…¥`check`é˜¶æ®µçš„é˜Ÿåˆ—

- å¤–å±‚`timers`é˜¶æ®µæ‰§è¡Œå®Œï¼Œè¿›å…¥`pending callbacks`ï¼Œ`idle, prepare`ï¼Œ`poll`ï¼Œè¿™å‡ ä¸ªé˜Ÿåˆ—éƒ½æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸‹

- åˆ°äº†`check`é˜¶æ®µï¼Œå‘ç°äº†`setImmediate`çš„å›è°ƒï¼Œæ‹¿å‡ºæ¥æ‰§è¡Œ

- ç„¶åæ˜¯`close callbacks`ï¼Œé˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œè·³è¿‡

- åˆæ˜¯`timers`é˜¶æ®µï¼Œæ‰§è¡Œæˆ‘ä»¬çš„`console`



#### demo2

```js
console.log('outer');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

setImmediate(() => {
  console.log('setImmediate');
});
```

è¿è¡Œç»“æœï¼š

```js
outer
setTimeout
setImmediate
```

ä½†æ˜¯è¿è¡Œç»“æœä¸å”¯ä¸€ï¼š

```
outer
setImmediate
setTimeout
```

**è§£é‡Šä¸Šé¢çš„æƒ…å†µï¼š**

node.jsé‡Œé¢`setTimeout(fn, 0)`ä¼šè¢«å¼ºåˆ¶æ”¹ä¸º`setTimeout(fn, 1)`

> å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼š**å½“`delay`å¤§äº`2147483647`æˆ–å°äº`1`æ—¶ï¼Œ`delay`å°†è®¾ç½®ä¸º`1`ã€‚éæ•´æ•°å»¶è¿Ÿè¢«æˆªæ–­ä¸ºæ•´æ•°ã€‚**

HTML 5é‡Œé¢`setTimeout`æœ€å°çš„æ—¶é—´é™åˆ¶æ˜¯4ms

å¯¹äºä¸Šé¢çš„æƒ…å†µï¼š

- é¦–å…ˆä¸Šè¿°ä»£ç åœ¨nodejsè¿›ç¨‹çš„jsçº¿ç¨‹ä¸­æ‰§è¡Œ(nodejsä¹Ÿæ˜¯å¤šçº¿ç¨‹çš„)
- é‡åˆ°`setTimeout`ï¼Œè™½ç„¶è®¾ç½®çš„æ˜¯0æ¯«ç§’è§¦å‘ï¼Œä½†æ˜¯è¢«node.jså¼ºåˆ¶æ”¹ä¸º1æ¯«ç§’ï¼Œå¡å…¥`times`é˜¶æ®µ
- é‡åˆ°`setImmediate`å¡å…¥`check`é˜¶æ®µ
- åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œè¿›å…¥Event Loop
- å…ˆè¿›å…¥`times`é˜¶æ®µï¼Œæ£€æŸ¥å½“å‰æ—¶é—´è¿‡å»äº†1æ¯«ç§’æ²¡æœ‰ï¼Œå¦‚æœè¿‡äº†1æ¯«ç§’ï¼Œæ»¡è¶³`setTimeout`æ¡ä»¶ï¼Œæ‰§è¡Œå›è°ƒï¼Œå¦‚æœæ²¡è¿‡1æ¯«ç§’ï¼Œè·³è¿‡
- è·³è¿‡ç©ºçš„é˜¶æ®µï¼Œè¿›å…¥checké˜¶æ®µï¼Œæ‰§è¡Œ`setImmediate`å›è°ƒ



è€Œæˆ‘ä»¬demo1ä¸­çš„ä¾‹å­æ˜¯åœ¨`timers`é˜¶æ®µï¼Œæ‰€ä»¥é‡Œé¢çš„`setTimeout`åªèƒ½ç­‰ä¸‹ä¸ªå¾ªç¯äº†ï¼Œæ‰€ä»¥`setImmediate`è‚¯å®šå…ˆæ‰§è¡Œ

åŒç†çš„è¿˜æœ‰å…¶ä»–`poll`é˜¶æ®µçš„APIä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚ï¼š

```js
var fs = require('fs')

fs.readFile(__filename, () => {
    setTimeout(() => {
        console.log('setTimeout');
    }, 0);
    setImmediate(() => {
        console.log('setImmediate');
    });
});
```

è¿™é‡Œ`setTimeout`å’Œ`setImmediate`åœ¨`readFile`çš„å›è°ƒé‡Œé¢ï¼Œç”±äº`readFile`å›è°ƒæ˜¯I/Oæ“ä½œï¼Œä»–æœ¬èº«å°±åœ¨`poll`é˜¶æ®µï¼Œæ‰€ä»¥ä»–é‡Œé¢çš„å®šæ—¶å™¨åªèƒ½è¿›å…¥ä¸‹ä¸ª`timers`é˜¶æ®µï¼Œä½†æ˜¯`setImmediate`å´å¯ä»¥åœ¨æ¥ä¸‹æ¥çš„`check`é˜¶æ®µè¿è¡Œï¼Œæ‰€ä»¥`setImmediate`è‚¯å®šå…ˆè¿è¡Œï¼Œä»–è¿è¡Œå®Œåï¼Œå»æ£€æŸ¥`timers`ï¼Œæ‰ä¼šè¿è¡Œ`setTimeout`ã€‚

ç±»ä¼¼çš„ï¼Œå†æ¥çœ‹ä¸€æ®µä»£ç ï¼Œå¦‚æœä»–ä»¬ä¸¤ä¸ªä¸æ˜¯åœ¨æœ€å¤–å±‚ï¼Œè€Œæ˜¯åœ¨`setImmediate`çš„å›è°ƒé‡Œé¢ï¼Œå…¶å®æƒ…å†µè·Ÿå¤–å±‚ä¸€æ ·ï¼Œç»“æœä¹Ÿæ˜¯éšç¼˜çš„ï¼Œçœ‹ä¸‹é¢ä»£ç :

```javascript
console.log('outer');

setImmediate(() => {
  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
  setImmediate(() => {
    console.log('setImmediate');
  });
});
```

åŸå› è·Ÿå†™åœ¨æœ€å¤–å±‚å·®ä¸å¤šï¼Œå› ä¸º`setImmediate`å·²ç»åœ¨`check`é˜¶æ®µäº†ï¼Œé‡Œé¢çš„å¾ªç¯ä¼šä»`timers`é˜¶æ®µå¼€å§‹ï¼Œä¼šå…ˆçœ‹`setTimeout`çš„å›è°ƒï¼Œå¦‚æœè¿™æ—¶å€™å·²ç»è¿‡äº†1æ¯«ç§’ï¼Œå°±æ‰§è¡Œä»–ï¼Œå¦‚æœæ²¡è¿‡å°±æ‰§è¡Œ`setImmediate`ã€‚



> `setImmediate`å’Œ`setTimeout(fn, 0)`å“ªä¸ªå›è°ƒå…ˆæ‰§è¡Œï¼Œéœ€è¦çœ‹ä»–ä»¬æœ¬èº«åœ¨å“ªä¸ªé˜¶æ®µæ³¨å†Œçš„ï¼Œå¦‚æœåœ¨å®šæ—¶å™¨å›è°ƒæˆ–è€…I/Oå›è°ƒé‡Œé¢ï¼Œ`setImmediate`è‚¯å®šå…ˆæ‰§è¡Œã€‚å¦‚æœåœ¨æœ€å¤–å±‚æˆ–è€…`setImmediate`å›è°ƒé‡Œé¢ï¼Œå“ªä¸ªå…ˆæ‰§è¡Œå–å†³äºå½“æ—¶æœºå™¨çŠ¶å†µã€‚



### process.nextTick() 

process.nextTick()æ¯” promise.then() çš„æ‰§è¡Œè¿˜æ—©ï¼Œåœ¨åŒæ­¥ä»»åŠ¡ä¹‹åï¼Œå…¶ä»–æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ä¹‹å‰ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œ nextTickã€‚å¯ä»¥æƒ³è±¡æ˜¯æŠŠ nextTick çš„ä»»åŠ¡æ”¾åˆ°äº†å½“å‰å¾ªç¯çš„åé¢ï¼Œä¸ promise.then() ç±»ä¼¼ï¼Œä½†æ¯” promise.then() æ›´å‰é¢ã€‚

æ„æ€å°±æ˜¯åœ¨å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆåï¼Œä¸ç®¡å…¶ä»–å¼‚æ­¥ä»»åŠ¡ï¼Œå…ˆå°½å¿«æ‰§è¡Œ nextTickã€‚

> process.nextTick æ˜¯ä¸€ä¸ªç‹¬ç«‹äº eventLoop çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚
>
> åœ¨æ¯ä¸€ä¸ª eventLoop é˜¶æ®µå®Œæˆåä¼šå»æ£€æŸ¥ nextTick é˜Ÿåˆ—ï¼Œå¦‚æœé‡Œé¢æœ‰ä»»åŠ¡ï¼Œä¼šè®©è¿™éƒ¨åˆ†ä»»åŠ¡ä¼˜å…ˆäºå¾®ä»»åŠ¡æ‰§è¡Œã€‚

```js
const promise = Promise.resolve()
setImmediate(() => {
  console.log('setImmediate');
});
promise.then(()=>{
    console.log('promise')
})
process.nextTick(()=>{
    console.log('nextTick')
})
```

è¿è¡Œç»“æœï¼š

```
nextTick
promise
setImmediate
```





### ä¸€ä¸ªdemo

```js
async function async1() {
  console.log('async start')
  await async2()
  console.log('async1 end')
}

async function async2() {
  console.log('async2')
}

console.log('script start')

setTimeout(function () {
  console.log('setTimeout0')
},0)

setTimeout(function () {
  console.log('setTimeout2')
},300)

setImmediate(() => console.log('setImmediate'))

process.nextTick(() => console.log('nextTick1'))

async1()

process.nextTick(() => console.log('nextTick2'))

new Promise(function (resolve) {
  console.log('promise1')
  resolve()
  console.log('promise2')
}).then(function () {
  console.log('promise3')
})

console.log('script end')
```

æ‰“å°ç»“æœï¼š

```js
script start
async start
async2
promise1
promise2
script end
nextTick1
nextTick2
async1 end
promise3
setTimeout0
setImmediate
setTimeout2
```

**åˆ†æ**ï¼š

å¯¹åº”çš„é˜Ÿåˆ—æœ‰ï¼š

```
 â‘  main script      â‘¡ nextTick       â‘¢ other micro        â‘£ timers        â‘¤ check
```

- é¦–å…ˆå®šä¹‰async1() å’Œ async2()ï¼Œç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç script startã€‚
- ç„¶åå°†setTimeout0åŠ å…¥timersé˜Ÿåˆ—ï¼Œè€Œå¯¹äºsetTimeout2ä¼šå…ˆè¿›è¡Œå®šæ—¶å™¨æ‰§è¡Œ300ms,æ­¤æ—¶è¿˜æ²¡æœ‰è¿›å…¥timersé˜Ÿåˆ—ã€‚
- ç„¶åå°†setImmediateæ”¾å…¥checké˜Ÿåˆ—ã€‚
- æ¥ä¸‹æ¥å°†nextTick1æ”¾å…¥nextTické˜Ÿåˆ—ã€‚
- æ‰§è¡Œasync1(),è¾“å‡ºasync1 satrt,ç„¶åè·³åˆ°async2()ä¸­ï¼Œè¾“å‡ºasync2,å†å›åˆ°async1()ä¸­ï¼Œå°†async1 endæ”¾å…¥other microé˜Ÿåˆ—ä¸­ã€‚
- æ¥ä¸‹æ¥å°†nextTick2æ”¾å…¥nextTické˜Ÿåˆ—ã€‚
- æ­¤æ—¶æ‰§è¡ŒPromsieä¸­çš„åŒæ­¥ä»£ç promise1ï¼Œå°†thençš„promise3æ”¾å…¥other microé˜Ÿåˆ—ä¸­ï¼Œç»§ç»­è¾“å‡ºpromise2ã€‚
- æ¥ä¸‹æ¥è¾“å‡ºscript endã€‚æ­¤æ—¶åŒæ­¥ä»£ç å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚
- å› ä¸ºnextTickçš„ä¼˜å…ˆçº§é«˜ï¼Œæ‰€ä»¥ä¾æ¬¡æ‰§è¡ŒnextTick1å’ŒnextTick2ã€‚
- ç„¶åæ‰§è¡Œother microé˜Ÿåˆ—ä¸­çš„ä»£ç ï¼Œè¾“å‡ºasync1 end,å†è¾“å‡ºpromise3ã€‚
- æ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—å·²ä¸ºç©ºï¼Œæ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`é¦–å…ˆè¿›å…¥timeré˜¶æ®µ`ï¼Œå…ˆè¾“å‡ºsetTimeout0ï¼Œç„¶åæ‰§è¡Œ`check`é˜Ÿåˆ—ï¼Œè¾“å‡ºsetImmediate
- æ³¨æ„ï¼Œæ­¤æ—¶setTimeout2çš„å®šæ—¶å™¨(å»¶è¿Ÿ300ms)æ‰§è¡Œå®Œæ¯•åï¼Œå°†å®ƒåŠ å…¥`timers`é˜Ÿåˆ—ï¼Œç„¶åå–å‡ºæ‰§è¡Œï¼Œè¾“å‡ºsetTimeout2ã€‚





## ä¸‰ã€æ€»ç»“

1. JSæ‰€è°“çš„â€œå•çº¿ç¨‹â€åªæ˜¯æŒ‡ä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸æ˜¯æ•´ä¸ªè¿è¡Œç¯å¢ƒéƒ½æ˜¯å•çº¿ç¨‹
2. JSçš„å¼‚æ­¥é åº•å±‚çš„å¤šçº¿ç¨‹å®ç°
3. å¼‚æ­¥çº¿ç¨‹ä¸ä¸»çº¿ç¨‹é€šè®¯é çš„æ˜¯Event Loop
4. å¼‚æ­¥çº¿ç¨‹å®Œæˆä»»åŠ¡åå°†å…¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—
5. ä¸»çº¿ç¨‹ä¸æ–­è½®è¯¢ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‹¿å‡ºä»»åŠ¡æ‰§è¡Œ
6. `process.nextTick`ä¸åœ¨Event Loopçš„ä»»ä½•é˜¶æ®µï¼Œä»–æ˜¯ä¸€ä¸ªç‰¹æ®ŠAPIï¼Œä»–ä¼šç«‹å³æ‰§è¡Œï¼Œç„¶åæ‰ä¼šç»§ç»­æ‰§è¡ŒEvent Loop





**å‚è€ƒæ–‡ç« **

[setTimeoutå’ŒsetImmediateåˆ°åº•è°å…ˆæ‰§è¡Œï¼Œæœ¬æ–‡è®©ä½ å½»åº•ç†è§£Event Loop](https://juejin.cn/post/6844904100195205133#heading-7)